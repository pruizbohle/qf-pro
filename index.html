<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO â€” Inicio</title>
  <link rel="stylesheet" href="./css/styles.css"/>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <strong>QF PRO</strong><br><span class="muted">Inicio</span>
    </div>
    <nav style="margin-top:12px">
      <a class="nav-item active" href="index.html">ğŸ·ï¸ Inicio</a>
      <a class="nav-item" href="sections/atencion.html">ğŸ§‘â€âš•ï¸ AtenciÃ³n farmacÃ©utica</a>
      <a class="nav-item" href="sections/generador.html">ğŸ“ Generador de texto</a>
      <a class="nav-item" href="sections/vademecum.html">ğŸ’Š VademÃ©cum</a>
      <a class="nav-item" href="sections/material.html">ğŸ“š Material de consulta</a>
      <a class="nav-item" href="sections/herramientas.html">ğŸ§° Herramientas</a>
      <a class="nav-item" href="sections/proa.html">ğŸ§ª PROA</a>
      <a class="nav-item" href="sections/plantas.html">ğŸŒ¿ Plantas medicinales</a>
      <a class="nav-item" href="sections/protocolos.html">ğŸ“‘ Orientaciones tÃ©cnicas</a>
      <a class="nav-item" href="sections/config.html">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>
  </aside>

  <!-- Main -->
  <div class="main">
    <div id="header"></div>

    <main class="container">
      <h2 style="margin-top:8px">Fichas activas</h2>
            <div class="card muted" style="margin-top:12px">La creaciÃ³n y administraciÃ³n de fichas se realiza desde <strong>AtenciÃ³n farmacÃ©utica</strong>.</div>
      <div id="fichas" class="fichas-wrap"></div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "./js/header.js";
  import { FichasStore } from "./js/fichasStore.js";
  mountHeader();

  const $wrap = document.getElementById('fichas');

  const TTL_MS = 3*24*60*60*1000;
  const fmt = ts => new Date(ts).toLocaleString();

  function pctRemaining(f){
    const elapsed = Date.now()-f.createdAt; const left = Math.max(0, TTL_MS-elapsed);
    return Math.round((left/TTL_MS)*100);
  }

  function card(f){
    const p = pctRemaining(f);
    const div = document.createElement('div');
    div.className = 'card ficha-card';
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <h3>${f.id}</h3>
        <span class="trash" title="Eliminar" data-del="1">ğŸ—‘ï¸</span>
      </div>
      <div class="muted">Creada: ${fmt(f.createdAt)} Â· Ãšlt. act.: ${fmt(f.lastActive)}</div>
      <div class="row" style="margin-top:8px;gap:8px">
        <a class="pill" href="sections/atencion.html#${f.id}">Abrir en AtenciÃ³n</a>
        <a class="pill" href="sections/generador.html#${f.id}">Generar texto</a>
      </div>
      <div class="timebar" title="Tiempo restante"><span style="width:${p}%"></span></div>
    `;
    div.querySelector('[data-del]')?.addEventListener('click',()=>{ FichasStore.remove(f.id); render(); });
    return div;
  }

  function render(){
    const L = FichasStore.list();
    $wrap.innerHTML = '';
    L.forEach(f=> $wrap.appendChild(card(f)));
    if(!L.length) $wrap.innerHTML = '<div class="card muted">â€” Sin fichas â€”</div>';
  }

  render(); setInterval(render, 60*1000); // refresca barras cada minuto
</script>
</body>
</html>