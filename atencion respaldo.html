<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO ‚Äî Atenci√≥n farmac√©utica</title>
  <link rel="stylesheet" href="../css/styles.css"/>
  <style>
    .mini{font-size:.9rem;opacity:.9}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#112036;border:1px solid rgba(148,163,184,.18);border-radius:999px;padding:4px 8px}
    .chip .x{margin-left:6px;cursor:pointer;opacity:.8}
    .seg-title{margin-top:14px;font-weight:700}
    .soft{opacity:.8}
    .muted{color:#a8b3cf}
    .sugg{display:none;border:1px solid rgba(148,163,184,.18); border-radius:10px; padding:6px; max-height:220px; overflow:auto; margin-top:6px}
    .sugg div{padding:6px 8px; cursor:pointer; border-radius:8px}
    .sugg div:hover{background:#0f172a}
    .sugg div.picked{outline:2px solid #4663ff; background:#0b224a}
    .qty-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{background:#0f213a;border:1px solid rgba(148,163,184,.18);padding:2px 8px;border-radius:999px}
    .recipe-head{display:flex;gap:8px;align-items:center;flex-wrap:wrap; background:#0c172c;border:1px solid rgba(148,163,184,.14); padding:8px 10px;border-radius:12px; margin-top:8px}
    .recipe{margin-top:8px;padding:8px;border:1px dashed rgba(148,163,184,.18); border-radius:12px}
    .row-end{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .btn-ghost{background:transparent;border:1px dashed rgba(148,163,184,.35)}
    .ea-btn{margin-left:8px}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Atenci√≥n</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">üè∑Ô∏è Inicio</a>
      <a class="nav-item active" href="atencion.html">üßë‚Äç‚öïÔ∏è Atenci√≥n farmac√©utica</a>
      <a class="nav-item" href="generador.html">üìù Generador de texto</a>
      <a class="nav-item" href="vademecum.html">üíä Vadem√©cum</a>
      <a class="nav-item" href="material.html">üìö Material de consulta</a>
      <a class="nav-item" href="herramientas.html">üß∞ Herramientas</a>
      <a class="nav-item" href="proa.html">üß™ PROA</a>
      <a class="nav-item" href="plantas.html">üåø Plantas medicinales</a>
      <a class="nav-item" href="protocolos.html">üìë Orientaciones t√©cnicas</a>
      <a class="nav-item" href="config.html">‚öôÔ∏è Configuraci√≥n</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>

    <main class="container grid2">
      <!-- Trabajo -->
      <section class="card">
        <!-- top -->
        <div class="row" style="gap:8px;justify-content:space-between;flex-wrap:wrap">
          <div class="row" style="gap:8px">
            <h2 id="titulo" class="muted">Sin ficha</h2>
            <label class="pick"><input type="checkbox" id="lock"> Bloquear</label>
          </div>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <label class="pick mini">Iniciales:
              <input id="ini" maxlength="3" style="text-transform:uppercase;width:80px" placeholder="ABC">
            </label>
            <label class="pick mini"><input type="checkbox" id="age65"> +65</label>
            <label class="pick mini">Sexo:
              <select id="sexo" style="width:80px"><option value="">‚Äî</option><option value="F">‚ôÄÔ∏è</option><option value="M">‚ôÇÔ∏è</option></select>
            </label>
            <button id="btn-crear" class="btn">Crear/abrir</button>
            <button id="btn-guardar" class="btn">Guardar</button>
          </div>
        </div>
        <div id="leyenda" class="muted"></div>

        <!-- Tabs -->
        <div class="row" style="gap:8px;margin-top:12px">
          <button class="tab-btn" data-tab="anam">ANAMNESIS</button>
          <button class="tab-btn" data-tab="meds">MEDICAMENTOS</button>
          <button class="tab-btn" data-tab="prm">PRM</button>
          <button class="tab-btn" data-tab="ea">Reacciones adversas</button>
          <button class="tab-btn" data-tab="tests">Tests</button>
          <button class="tab-btn" data-tab="calc">Calculadoras</button>
          <button class="tab-btn" data-tab="obs">Observaciones</button>
        </div>

        <!-- ===== ANAMNESIS ===== -->
        <div id="panel-anam" class="card" style="margin-top:10px">
          <!-- ANTECEDENTES -->
          <div class="seg-title">ANTECEDENTES</div>
          <div class="row" style="gap:8px;margin-top:6px;flex-wrap:wrap">
            <input id="ant-input" list="ant-suggest" placeholder="Escribe y Enter: HTA, DM2 IR, ERC3‚Ä¶">
            <datalist id="ant-suggest"></datalist>
            <div id="ant-list" class="chips"></div>
          </div>

          <!-- MOTIVO -->
          <div class="seg-title">MOTIVO DE CONSULTA</div>
          <div class="row" style="gap:10px;margin-top:6px;flex-wrap:wrap">
            <label class="pick"><input type="checkbox" data-mot="adh"> Evaluaci√≥n de adherencia</label>
            <label class="pick"><input type="checkbox" data-mot="educ"> Educaci√≥n</label>
            <label class="pick"><input type="checkbox" data-mot="ea"> Evaluaci√≥n de reacci√≥n adversa</label>
          </div>

          <!-- DATOS PERSONALES -->
          <div class="seg-title">DATOS PERSONALES</div>
          <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:6px">
            <label class="pick">Asiste:
              <select id="dp-acomp"><option value="solo">solo</option><option value="acompanado">acompa√±ado</option></select>
            </label>
            <label class="pick">Vive:
              <select id="dp-convive"><option value="solo">solo</option><option value="con">con‚Ä¶</option></select>
            </label>
            <input id="dp-conquien" placeholder="¬øcon qui√©n? (si aplica)" style="min-width:200px">
            <label class="pick">Sector:
              <select id="dp-sector"><option value="urbano">urbano</option><option value="rural">rural</option></select>
            </label>
            <input id="dp-ocup" placeholder="Ocupaci√≥n‚Ä¶" style="min-width:200px">
            <input id="dp-jub" placeholder="Jubilado/pensionado (texto)‚Ä¶" style="min-width:220px">
          </div>
          <div class="row" style="gap:14px;margin-top:6px;flex-wrap:wrap">
            <label class="pick"><input type="checkbox" id="dp-ana"> Analfabeto</label>
            <label class="pick"><input type="checkbox" id="dp-dep"> Dependiente severo</label>
            <label class="pick"><input type="checkbox" id="dp-ayt"> Ayudas t√©cnicas</label>
            <label class="pick"><input type="checkbox" id="an-emb"> Embarazo en curso / posible</label>
          </div>

          <!-- RESPECTO A LA TERAPIA -->
          <div class="seg-title">RESPECTO A LA TERAPIA</div>
          <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:6px">
            <label class="pick">Percepci√≥n:
              <select id="tx-carga">
                <option value="apropiada">toma una cantidad apropiada</option>
                <option value="muchos">cree que toma muchos</option>
              </select> medicamentos
            </label>
            <label class="pick">Si se siente bien/mal:
              <select id="tx-abandono">
                <option value="no-deja">no deja</option>
                <option value="deja">deja</option>
              </select> de tomarlos
            </label>
          </div>
          <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:6px">
            <input id="tx-pat" placeholder="Patolog√≠a que m√°s preocupa‚Ä¶">
            <input id="tx-med" placeholder="Medicamento que m√°s prioriza‚Ä¶">
          </div>
          <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:6px">
            <label class="pick">Conocimiento nombres:
              <select id="tx-nom"><option value="conoce">conoce</option><option value="algunos">conoce algunos</option><option value="no-conoce">no conoce</option></select>
            </label>
            <label class="pick">Conocimiento posolog√≠a:
              <select id="tx-pos"><option value="conoce">conoce</option><option value="moderado">conoce moderadamente</option><option value="no-conoce">no conoce</option></select>
            </label>
            <label class="pick">Conocimiento indicaciones:
              <select id="tx-ind"><option value="conoce">conoce</option><option value="moderado">conoce moderadamente</option><option value="no-conoce">no conoce</option></select>
            </label>
          </div>

          <textarea id="anam-notas" rows="5" style="width:100%;margin-top:10px" placeholder="Notas libres‚Ä¶"></textarea>
        </div>

        <!-- ===== MEDICAMENTOS ===== -->
        <div id="panel-meds" class="card" style="margin-top:10px;display:none">
          <div class="muted">Flujo: (APS/SEC) <b>AGREGAR RECETA</b> ‚Üí buscar f√°rmaco (incluye presentaci√≥n) ‚Üí cantidad ‚Üí frecuencia. En Particular/Automedic. <b>AGREGAR MEDICAMENTOS</b>. Duplicados bloqueados por receta/nivel.</div>

          <!-- Plantillas -->
          <template id="sku-controls-tpl">
            <div class="qty-row">
              <div class="seg-qty"></div>
              <select class="seg-pos" style="min-width:160px">
                <option>CADA 24 HORAS</option><option>CADA 12 HORAS</option><option>CADA 8 HORAS</option><option>SOS</option>
              </select>
              <button class="btn seg-add" disabled>Agregar</button>
            </div>
          </template>

          <template id="searchbox-tpl">
            <div class="searchbox">
              <input class="seg-search" placeholder="Escribe al menos 2 letras para buscar‚Ä¶" style="min-width:520px">
              <div class="sugg seg-sugg"></div>
            </div>
          </template>

          <template id="recipe-tpl">
            <div class="recipe">
              <div class="recipe-head">
                <label>Fecha receta: <input type="date" class="rec-fecha"></label>
                <label>Duraci√≥n (meses): <input type="number" min="1" step="1" value="3" class="rec-meses" style="width:90px"></label>
                <button class="btn-ghost rec-del">Eliminar receta</button>
              </div>
              <div class="seg-box" style="margin-top:8px"></div>
              <ul class="list seg-list" style="margin-top:8px"></ul>
            </div>
          </template>

          <!-- APS -->
          <div class="seg-title">APS</div>
          <div id="aps-recetas"></div>
          <div class="row-end">
            <button id="aps-add-rec" class="btn">AGREGAR RECETA</button>
            <button id="btn-import-rayen" class="btn">IMPORTAR RECETA</button>
          </div>

          <!-- Secundario -->
          <div class="seg-title" style="margin-top:14px">Secundario</div>
          <div id="sec-recetas"></div>
          <div class="row-end">
            <button id="sec-add-rec" class="btn">AGREGAR RECETA</button>
          </div>

          <!-- Particular -->
          <div class="seg-title" style="margin-top:14px">Particular</div>
          <div id="extra-box" class="recipe"></div>

          <!-- Automedicaci√≥n -->
          <div class="seg-title" style="margin-top:14px">Automedicaci√≥n</div>
          <div id="auto-box" class="recipe">
            <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
              <input id="auto-line" placeholder="Ej: IBUPROFENO 400 MG A DEMANDA" style="flex:1">
              <button id="auto-add" class="btn">AGREGAR MEDICAMENTOS</button>
            </div>
            <ul id="auto-list" class="list" style="margin-top:8px"></ul>
          </div>

          <!-- Plantas -->
          <div class="seg-title" style="margin-top:14px">Plantas medicinales</div>
          <div id="pl-box" class="recipe">
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <select id="pl-sel" style="min-width:220px"></select>
              <button id="pl-add" class="btn">AGREGAR PLANTAS</button>
            </div>
            <ul id="pl-list" class="list" style="margin-top:8px"></ul>
          </div>
        </div>

        <!-- ===== PRM ===== -->
        <div id="panel-prm" class="card" style="margin-top:10px;display:none">
          <ul id="prm-list" class="list"></ul>
        </div>

        <!-- ===== EA ===== -->
        <div id="panel-ea" class="card" style="margin-top:10px;display:none">
          <div class="muted">EA/ RAM agregadas desde los botones <b>EA</b> en cada medicamento, o desde aqu√≠.</div>
          <div class="row" style="gap:8px;margin-top:8px">
            <select id="ea-med" style="min-width:260px"></select>
            <select id="ea-efx" style="min-width:260px"></select>
            <button id="ea-add" class="btn">Agregar EA</button>
          </div>
          <ul id="ea-list" class="list" style="margin-top:10px"></ul>
        </div>

        <!-- ===== TESTS (s√≥lo resultados ligados a ficha) ===== -->
        <div id="panel-tests" class="card" style="margin-top:10px;display:none">
          <h3>Resultados de Tests (guardados en ficha)</h3>
          <ul id="tests-list" class="list"></ul>
          <div class="muted" style="margin-top:6px">Para aplicar tests, usa la secci√≥n <b>Tests</b>. Aqu√≠ s√≥lo se listan los resultados guardados.</div>
        </div>

        <!-- ===== CALC ===== -->
        <div id="panel-calc" class="card" style="margin-top:10px;display:none">
          <h3>Resultados de Calculadoras (guardados en ficha)</h3>
          <ul id="calc-list" class="list"></ul>
          <div class="muted" style="margin-top:6px">Para calcular, usa la secci√≥n <b>Calculadoras</b>.</div>
        </div>

        <!-- ===== OBS ===== -->
        <div id="panel-obs" class="card" style="margin-top:10px;display:none"><textarea id="obs" rows="5" style="width:100%" placeholder="Observaciones‚Ä¶"></textarea></div>
      </section>

      <!-- Lateral fichas -->
      <aside class="right-list">
        <h3>Fichas</h3>
        <div id="lista" class="list"></div>
      </aside>
      
      <!-- Modal Importar Rayen -->
<div id="import-rayen-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,.6);z-index:1000;justify-content:center;align-items:center;">
  <div style="background:#0f172a;border:1px solid rgba(148,163,184,.3);padding:20px;border-radius:12px;
      width:90%;max-width:700px;max-height:90%;overflow:auto;">
    <h3>Importar receta desde Rayen</h3>
    <textarea id="rayen-input" placeholder="Pega aqu√≠ el texto desde Rayen..." 
      rows="12" style="width:100%;margin-top:10px;background:#111827;color:#f9fafb;
      border:1px solid rgba(148,163,184,.3);border-radius:8px;padding:8px;"></textarea>
    <div class="row-end" style="margin-top:12px;gap:8px;">
      <button id="rayen-cancel" class="btn-ghost" style="border-color:#ef4444;color:#ef4444">Cancelar</button>
      <button id="rayen-process" class="btn">Procesar</button>
    </div>
  </div>
</div>

    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { FichasStore } from "../js/fichasStore.js";
  import { loadAll } from "../js/medStore.js";
  mountHeader();

  const $ = sel=>document.querySelector(sel);
  const fmt = ts => new Date(ts).toLocaleString();
  const debounce=(fn,ms=600)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  let DB=null, PLANTAS={};
  const ANT_TODOS=["HTA","DM2 IR","DM2 NIR","DLP","HIPOT4","ERC3","ERC4","POLIARTROSIS","OB","TR SUE√ëO","TR DEPRESIVO"];

  const $ini=$('#ini'), $age65=$('#age65'), $sexo=$('#sexo');
  const $crear=$('#btn-crear'), $lista=$('#lista'), $titulo=$('#titulo'), $leyenda=$('#leyenda'), $lock=$('#lock'), $guardar=$('#btn-guardar');
  const tabs=['anam','meds','prm','ea','tests','calc','obs'];
  let currentTab = 'anam';  // estado global de la pesta√±a activa

  loadAll().then(db=>{
    DB=db;
    try{ fetch('../data/plantas.json').then(r=>r.json()).then(p=>{ PLANTAS=p; $('#pl-sel').innerHTML=Object.values(PLANTAS).map(p=>`<option value="${p.id}">${p.nombre}</option>`).join(''); }); }catch{}
    initAntecedentes();
    initMedsUI();
    renderLista();
    const hash=(location.hash||'').replace('#','').toUpperCase(); if(hash) openFicha(hash);
  });

  function showTab(k){
  currentTab = k;  // üëà guarda pesta√±a
  tabs.forEach(t=>$('#panel-'+t).style.display=(t===k)?'block':'none');
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===k));
}
  document.querySelectorAll('.tab-btn').forEach(b=> b.onclick=()=> showTab(b.dataset.tab));

  function renderLista(){
    const sym=s=>s==='F'?'‚ôÄÔ∏è':(s==='M'?'‚ôÇÔ∏è':'');
    const L=FichasStore.list().sort((a,b)=>a.id.localeCompare(b.id));
    $lista.innerHTML = L.map(f=>`
      <div class="card ficha-card">
        <div class="row" style="justify-content:space-between">
          <b>${f.id}${sym(f.sexo)?' ¬∑ '+sym(f.sexo):''}${f.age65?' ¬∑ +65':''}</b>
          <span class="trash" title="Eliminar" data-del="${f.id}">üóëÔ∏è</span>
        </div>
        <div class="muted">Ult. act.: ${fmt(f.lastActive)}</div>
        <div class="row" style="gap:6px;margin-top:8px"><button class="btn" data-open="${f.id}">Abrir</button></div>
      </div>
    `).join('') || '<div class="muted">‚Äî sin fichas ‚Äî</div>';
    $lista.querySelectorAll('[data-open]').forEach(b=> b.onclick=()=> openFicha(b.dataset.open));
    $lista.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ FichasStore.remove(b.dataset.del); if(activeId===b.dataset.del) activeId=null; renderLista(); clearWork(); });
  }
  function clearWork(){ $titulo.textContent='Sin ficha'; $leyenda.textContent=''; showTab('anam'); }

  let activeId=null;
  $crear.onclick=()=>{
    const ini=($ini.value||'').toUpperCase().trim();
    if(!/^[A-Z]{3}$/.test(ini)){ alert("Iniciales: 3 letras MAY√öSCULAS (solo letras)."); return; }
    const exists=FichasStore.get(ini);
    if(exists){ openFicha(ini); return; }
    try{ FichasStore.create(ini,{age65:$age65.checked,sexo:$sexo.value}); renderLista(); openFicha(ini); $ini.value=''; }catch(e){ alert(e.message); }
  };
  $lock.onchange=()=>{ if(activeId) FichasStore.setLocked(activeId,$lock.checked); };
  $guardar.onclick=()=>{ if(activeId) alert('Guardado'); };

  // ===== ANTECEDENTES
  function initAntecedentes(){
    const dl=$('#ant-suggest'); dl.innerHTML=ANT_TODOS.map(x=>`<option value="${x}">`).join('');
    const inp=$('#ant-input'), list=$('#ant-list');
    function renderAnt(f){
      list.innerHTML=(f.anamnesis.antecedentes||[]).map(a=>`<span class="chip">${a}<span class="x" data-x="${a}">‚úï</span></span>`).join('')||'';
      list.querySelectorAll('[data-x]').forEach(x=> x.onclick=()=>{ FichasStore.update(activeId, ff=> ff.anamnesis.antecedentes = ff.anamnesis.antecedentes.filter(z=>z!==x.dataset.x)); renderAnt(FichasStore.get(activeId)); computePRM(); });
    }
    inp.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const v=(inp.value||'').trim(); if(!v) return;
        if(!ANT_TODOS.includes(v)) { alert('Usa una de las sugerencias.'); return; }
        FichasStore.update(activeId, f=>{ if(!f.anamnesis.antecedentes.includes(v)) f.anamnesis.antecedentes.push(v); });
        inp.value=''; renderAnt(FichasStore.get(activeId)); computePRM();
      }
    });
    initAntecedentes.renderAnt=renderAnt;
  }

  // ===== MEDS UI
  function initMedsUI(){
    // Estructura en store:
    // f.meds.apsRecetas: [{id, fechaISO, meses, meds:[]}]
    // f.meds.secRecetas: [{...}]
    // f.meds.extra: []   (particular)
    // f.meds.automed: [], f.meds.plantas: []
    // (mantenemos automed/plantas)

    // Construir ‚ÄúParticular‚Äù
    buildSimpleBox('#extra-box','extra');

    // Automedicaci√≥n
    $('#auto-add').onclick=()=>{ if(!activeId) return; const v=($('#auto-line').value||'').trim(); if(!v) return; FichasStore.update(activeId, f=> f.meds.automed.push({texto:v,fecha:Date.now()})); $('#auto-line').value=''; openFicha(activeId); showTab('meds'); };

    // Plantas
    $('#pl-add').onclick=()=>{ if(!activeId) return; const id=$('#pl-sel').value; const p=PLANTAS[id]; if(!p) return; FichasStore.update(activeId, f=> f.meds.plantas.push({id, nombre:p.nombre})); openFicha(activeId); showTab('meds'); };

    // Recetas APS / Secundario
    $('#aps-add-rec').onclick=()=> addRec('apsRecetas','#aps-recetas');
    $('#sec-add-rec').onclick=()=> addRec('secRecetas','#sec-recetas');
  }

  // Crear receta y montar UI
  function addRec(kind, hostSel){
    if(!activeId) return;
    const id = 'R'+Math.random().toString(36).slice(2,7).toUpperCase();
    FichasStore.update(activeId, f=>{
      f.meds[kind] = f.meds[kind]||[];
      f.meds[kind].push({id, fechaISO: new Date().toISOString().slice(0,10), meses: 3, meds: []});
    });
    renderRecetas(kind, hostSel);
  }

  function renderRecetas(kind, hostSel){
    const host = $(hostSel); host.innerHTML = '';
    const f = FichasStore.get(activeId); if(!f) return;
    (f.meds[kind]||[]).forEach(rec=>{
      const tpl = $('#recipe-tpl').content.cloneNode(true);
      const node = tpl.querySelector('.recipe');
      const headFecha = tpl.querySelector('.rec-fecha');
      const headMeses = tpl.querySelector('.rec-meses');
      const delBtn = tpl.querySelector('.rec-del');
      const segBox = tpl.querySelector('.seg-box');
      const list = tpl.querySelector('.seg-list');

      headFecha.value = rec.fechaISO||new Date().toISOString().slice(0,10);
      headMeses.value = rec.meses||3;
      headFecha.onchange=()=> FichasStore.update(activeId, ff=>{ const r=findRec(ff,kind,rec.id); if(r) r.fechaISO=headFecha.value; });
      headMeses.oninput=()=> FichasStore.update(activeId, ff=>{ const r=findRec(ff,kind,rec.id); if(r) r.meses=+headMeses.value||1; });

      delBtn.classList.add('btn-ghost'); // ya est√°, dejamos la clase
delBtn.style.borderColor = '#ef4444';  // rojo suave
delBtn.style.color = '#ef4444';

delBtn.onclick=()=>{
  if(!confirm('¬øEliminar esta receta completa?')) return;
  FichasStore.update(activeId, ff=>{
    ff.meds[kind] = (ff.meds[kind]||[]).filter(x=>x.id!==rec.id);
  });
  renderRecetas(kind,hostSel);
  computePRM();
};

      // Buscar + agregar dentro de la receta
      mountSearchControls(segBox, kind, rec.id, list);
      drawMedsList(kind, rec.id, list);

      host.appendChild(tpl);
    });
  }
  function findRec(f,k,id){ return (f.meds[k]||[]).find(r=>r.id===id); }

  // ‚ÄúParticular‚Äù y otros simples sin receta
  function buildSimpleBox(hostSel, key){
    const host=$(hostSel); host.innerHTML='';
    const search = $('#searchbox-tpl').content.cloneNode(true);
    const controls = $('#sku-controls-tpl').content.cloneNode(true);
    host.appendChild(search); host.appendChild(controls);

    const sugg = host.querySelector('.seg-sugg');
    const input = host.querySelector('.seg-search');
    const qty = host.querySelector('.seg-qty');
    const pos = host.querySelector('.seg-pos');
    const add = host.querySelector('.seg-add');
    let picked=null;

    input.oninput = ()=>{
      const q=(input.value||'').trim().toUpperCase();
      if(q.length<2){ sugg.style.display='none'; sugg.innerHTML=''; picked=null; add.disabled=true; return; }
      const pool = DB.skus.filter(s=> !s.aps || key!=='extra' ? true : true); // solo filtro de ejemplo
      const items = pool.filter(s=> s.nombre.includes(q)).slice(0,60);
      sugg.style.display='block';
      sugg.innerHTML = items.map(s=>`<div data-sku="${s.skuId}">${s.nombre}</div>`).join('') || '<div class="muted">Sin resultados</div>';
      sugg.querySelectorAll('[data-sku]').forEach(d=> d.onclick=()=>{
        sugg.querySelectorAll('div').forEach(n=>n.classList.remove('picked'));
        d.classList.add('picked');
        picked=DB.skuById[d.dataset.sku];
        renderQtyUI(picked, qty);
        add.disabled=false;
      });
    };

    add.onclick=()=>{
      if(!activeId || !picked) return;
      if(isDupSimple(key, picked.base)){ alert('Ese f√°rmaco ya est√° en este nivel.'); return; }
      const payload = buildMedPayload(picked, qty, pos);
      FichasStore.update(activeId, f=>{ f.meds[key]=f.meds[key]||[]; f.meds[key].push(payload); });
      input.value=''; sugg.innerHTML=''; sugg.style.display='none'; add.disabled=true; picked=null;
      openFicha(activeId); showTab('meds');
    };

    function draw(){ const f=FichasStore.get(activeId); const arr=f?.meds[key]||[]; host.querySelector('.list')?.remove();
      const ul=document.createElement('ul'); ul.className='list'; ul.style.marginTop='8px';
      ul.innerHTML = arr.length ? arr.map((x,i)=> liMed(x, key, null, i)).join('') : '<div class="muted">‚Äî vac√≠o ‚Äî</div>';
      host.appendChild(ul);
      bindListButtons(ul, key, null);
    }
    host.drawList = draw;
  }

  // montar controles de b√∫squeda dentro de una receta
  function mountSearchControls(container, kind, recId, listNode){
    container.innerHTML='';
    const search = $('#searchbox-tpl').content.cloneNode(true);
    const controls = $('#sku-controls-tpl').content.cloneNode(true);
    container.appendChild(search); container.appendChild(controls);

    const input = container.querySelector('.seg-search');
    const sugg = container.querySelector('.seg-sugg');
    const qty = container.querySelector('.seg-qty');
    const pos = container.querySelector('.seg-pos');
    const add = container.querySelector('.seg-add');
    let picked=null;

    input.oninput=()=>{
      const q=(input.value||'').trim().toUpperCase();
      if(q.length<2){ sugg.style.display='none'; sugg.innerHTML=''; picked=null; add.disabled=true; return; }
      let pool = DB.skus;
      if(kind==='apsRecetas') pool=pool.filter(s=> s.aps);
// if(kind==='secRecetas') pool=pool.filter(s=> s.secundario);  // TODO: activar cuando JSON tenga SECUNDARIO marcado

      const items = pool.filter(s=> s.nombre.includes(q)).slice(0,60);
      sugg.style.display='block';
      sugg.innerHTML = items.map(s=>`<div data-sku="${s.skuId}">${s.nombre}</div>`).join('') || '<div class="muted">Sin resultados</div>';
      sugg.querySelectorAll('[data-sku]').forEach(d=> d.onclick=()=>{
        sugg.querySelectorAll('div').forEach(n=>n.classList.remove('picked'));
        d.classList.add('picked');
        picked=DB.skuById[d.dataset.sku];
        renderQtyUI(picked, qty);
        add.disabled=false;
      });
    };

    add.onclick=()=>{
      if(!activeId || !picked) return;
      if(isDupInRecipe(kind, recId, picked.base)){ alert('Ese f√°rmaco ya est√° en esta receta.'); return; }
      const payload = buildMedPayload(picked, qty, pos);
      FichasStore.update(activeId, f=>{ const r=findRec(f,kind,recId); if(r){ r.meds.push(payload);} });
      input.value=''; sugg.innerHTML=''; sugg.style.display='none'; add.disabled=true; picked=null;
      drawMedsList(kind, recId, listNode); computePRM();
    };
  }

  // payload de medicamento
  function buildMedPayload(picked, qtyNode, posNode){
    const forma = picked.forma || 'comprimido';
    const posologia = (posNode.value||'').toUpperCase();
    let cantidad=null, unidad=null, uiAm=null, uiPm=null;
    const id=qtyNode.id || (qtyNode.id='q'+Math.random().toString(36).slice(2,7));
    if(forma==='comprimido' || forma==='capsula'){
      cantidad = document.getElementById(id+'-cant')?.value || '1';
      unidad = 'COMPRIMIDO(S)';
    }else if(forma==='suspension'){
      cantidad = document.getElementById(id+'-ml')?.value || '5';
      unidad = 'ML';
    }else if(forma==='inhalador'){
      cantidad = document.getElementById(id+'-puff')?.value || '2';
      unidad = 'PUFF';
    }else if(forma==='insulina'){
      uiAm = document.getElementById(id+'-am')?.value || '0';
      uiPm = document.getElementById(id+'-pm')?.value || '0';
      unidad = 'UI';
    }
    return {
      sku: picked.skuId, base: picked.base, nombre: picked.nombre,
      presentacion: picked.presentacion, forma, cantidad, unidad, uiAm, uiPm, posologia
    };
  }

  // duplicidad por base
  function isDupInRecipe(kind, recId, base){
    const f=FichasStore.get(activeId); const r=findRec(f,kind,recId); if(!r) return false;
    return r.meds.some(m=> (m.base||'')===base);
  }
  function isDupSimple(key, base){
    const f=FichasStore.get(activeId); const arr=f?.meds[key]||[];
    return arr.some(m=> (m.base||'')===base);
  }

  // dibuja lista de meds en receta
  function drawMedsList(kind, recId, listNode){
    const f=FichasStore.get(activeId); const r=findRec(f,kind,recId); if(!r) return;
    listNode.innerHTML = r.meds.length ? r.meds.map((x,i)=> liMed(x, kind, recId, i)).join('') : '<div class="muted">‚Äî sin medicamentos ‚Äî</div>';
    bindListButtons(listNode, kind, recId);
  }

  // LI de medicamento (con bot√≥n EA)
function liMed(x, kind, recId, idx){
  // ¬øEl nombre ya trae la posolog√≠a inline?
  const nombreUpper = (x.nombre || '').toUpperCase();
  const yaLlevaPos = /\b(CADA|SOS)\b/.test(nombreUpper);

  // Solo agregamos cantidad/unidad si NO viene inline
  let cant = '';
  if (!yaLlevaPos) {
    if ((x.forma || '').toLowerCase() === 'insulina' && (x.uiAm || x.uiPm)) {
      cant = ` ${x.uiAm || 0} UI AM - ${x.uiPm || 0} UI PM`;
    } else if (x.cantidad) {
      cant = ` ${x.cantidad} ${x.unidad || ''}`;
    }
  }

  // No mostrar x.posologia si ya viene inline (adem√°s la dejamos vac√≠a al importar)
  const posTxt = (!yaLlevaPos && x.posologia) ? ` ${x.posologia}` : '';

  const data = `data-kind="${kind}" ${recId ? `data-rec="${recId}"` : ''} data-idx="${idx || 0}"`;
  return `<li class="row"><span>${(x.nombre || '')}${cant}${posTxt}</span>
    <span>
      <button class="btn ea-btn" ${data} data-ea>EA</button>
      <button class="btn" ${data} data-rm>Quitar</button>
    </span>
  </li>`;
}

  function bindListButtons(scope, kind, recId){
    scope.querySelectorAll('[data-rm]').forEach(b=> b.onclick=()=>{
      const k=b.dataset.kind, i=+b.dataset.idx;
      FichasStore.update(activeId, f=>{
        if(b.dataset.rec){ const r=findRec(f,k,b.dataset.rec); if(r) r.meds.splice(i,1); }
        else { f.meds[k].splice(i,1); }
      });
      openFicha(activeId); showTab('meds');
    });

    scope.querySelectorAll('[data-ea]').forEach(b=> b.onclick=()=>{
      const k=b.dataset.kind, i=+b.dataset.idx;
      const f=FichasStore.get(activeId);
      const med = b.dataset.rec ? findRec(f,k,b.dataset.rec).meds[i] : (f.meds[k]||[])[i];
      openEAFor(med);
    });
  }

  // ===== EA
  const EA_DEFAULT = ["N√ÅUSEAS", "MAREO", "SOMNOLENCIA", "MIALGIAS", "EDEMA"];
  const EA_MET = ["N√ÅUSEAS", "DIARREA", "DOLOR ABDOMINAL", "FLATULENCIAS", "SABOR MET√ÅLICO"];
  function optionsEA(base){ return (base==='metformina')?EA_MET:EA_DEFAULT; }

  function openEAFor(med){
    if(!activeId || !med) return;
    const sel=$('#ea-med'), eff=$('#ea-efx');
    sel.innerHTML = `<option value="${med.sku}" data-base="${med.base}">${med.nombre}</option>`;
    eff.innerHTML = optionsEA(med.base).map(e=>`<option>${e}</option>`).join('');
    showTab('ea');
  }
  $('#ea-add').onclick=()=>{
    if(!activeId) return;
    const sel=$('#ea-med'), eff=$('#ea-efx');
    const sku=sel.value; if(!sku){ alert("Selecciona medicamento."); return; }
    const base = sel.selectedOptions[0]?.dataset.base || '';
    const nombre = DB.skuById[sku]?.nombre || sku;
    const efecto = eff.value;
    FichasStore.update(activeId, f=> f.eventosAdversos.push({ medSku:sku, base, medNombre:nombre, efecto, fecha:Date.now() }));
    openFicha(activeId); showTab('ea');
  };

  // ===== abrir ficha
  function openFicha(id){
    const f=FichasStore.get(id); if(!f) return;
    activeId=id;
    $titulo.textContent=`Ficha: ${id}`;
    $lock.checked=!!f.locked;
    $leyenda.textContent=`Creada: ${fmt(f.createdAt)} ¬∑ √ölt. act.: ${fmt(f.lastActive)}${f.age65?' ¬∑ +65':''}${f.sexo?(' ¬∑ '+(f.sexo==='F'?'‚ôÄÔ∏è':'‚ôÇÔ∏è')):''}`;

    initAntecedentes.renderAnt(f);

    document.querySelectorAll('[data-mot]').forEach(c=>{
      c.checked = !!f.anamnesis.motivo.includes(c.dataset.mot);
      c.onchange = ()=>{ FichasStore.update(activeId, ff=>{ const s=new Set(ff.anamnesis.motivo||[]); c.checked?s.add(c.dataset.mot):s.delete(c.dataset.mot); ff.anamnesis.motivo=[...s]; computePRM(); }); };
    });

    fillVal('dp-acomp',f.datos.acompana); fillVal('dp-convive',f.datos.convive); fillVal('dp-conquien',f.datos.conQuien);
    fillVal('dp-sector',f.datos.sector); fillVal('dp-ocup',f.datos.ocupacion); fillVal('dp-jub',f.datos.jubilacion);
    fillChk('dp-ana',f.datos.analfabeto); fillChk('dp-dep',f.datos.dependienteSevero); fillChk('dp-ayt',f.datos.ayudasTecnicas);
    bindDatosPersonales();
    fillChk('an-emb', !!f.anamnesis.embarazo);
document.getElementById('an-emb').onchange = ()=>{
  FichasStore.update(activeId, ff=> ff.anamnesis.embarazo = !!document.getElementById('an-emb').checked);
  computePRM();
};

    const $an=$('#anam-notas'); $an.value=f.anamnesis.textoLibre||''; $an.oninput=debounce(()=>{FichasStore.update(activeId, ff=> ff.anamnesis.textoLibre=$an.value);},600);

    // Render recetas APS/SEC y particular/auto/plantas
    renderRecetas('apsRecetas','#aps-recetas');
    renderRecetas('secRecetas','#sec-recetas');
    $('#extra-box').drawList?.();

    // automed/plantas list
    const al=$('#auto-list');
    al.innerHTML = f.meds.automed.length ? f.meds.automed.map((x,i)=>`<li class="row"><span>${(x.texto||'').toUpperCase()}</span><button class="btn" data-ra="${i}">Quitar</button></li>`).join("") : '<div class="muted">‚Äî vac√≠o ‚Äî</div>';
    al.querySelectorAll('[data-ra]').forEach(b=> b.onclick=()=>{ FichasStore.update(activeId, ff=> ff.meds.automed.splice(+b.dataset.ra,1)); openFicha(activeId); });

    const pl=$('#pl-list');
    pl.innerHTML = f.meds.plantas.length ? f.meds.plantas.map((x,i)=>`<li class="row"><span>${x.nombre}</span><button class="btn" data-rp="${i}">Quitar</button></li>`).join("") : '<div class="muted">‚Äî vac√≠o ‚Äî</div>';
    pl.querySelectorAll('[data-rp]').forEach(b=> b.onclick=()=>{ FichasStore.update(activeId, ff=> ff.meds.plantas.splice(+b.dataset.rp,1)); openFicha(activeId); });

    // EA y resultados de Tests / Calcs
    populateEaSelect(f); renderEA(f);
    renderStatic('tests-list', f.tests);
    renderStatic('calc-list', f.calculos);

    // PRM
    computePRM();
  }

  function renderStatic(id, arr=[]){
    const ul = document.getElementById(id);
    ul.innerHTML = arr.length ? arr.slice().reverse().map(x=>`<li class="card"><span>${x.tipo}: ${x.resultado}</span><span class="pill">${fmt(x.fecha)}</span></li>`).join('') : '<div class="muted">‚Äî vac√≠o ‚Äî</div>';
  }

  // EA select global
  function populateEaSelect(f){
    const sel=$('#ea-med'); const eff=$('#ea-efx');
    const uniq = new Map();
getAllMeds(f).forEach(x=>{
  const key = x.base;             // o x.nombre.toUpperCase()
  if(!uniq.has(key)) uniq.set(key, {sku:x.sku, base:x.base, nombre:x.nombre});
});
const items = Array.from(uniq.values());
sel.innerHTML = items.length 
  ? items.map(x=>`<option value="${x.sku}" data-base="${x.base}">${x.nombre}</option>`).join("") 
  : `<option value="">‚Äî</option>`;
    function refreshEff(){ const base=sel.selectedOptions[0]?.dataset.base||''; eff.innerHTML = optionsEA(base).map(e=>`<option>${e}</option>`).join(''); }
    sel.onchange=refreshEff; refreshEff();
  }
  function renderEA(f){
    const ul=$('#ea-list');
    ul.innerHTML = f.eventosAdversos.length ? f.eventosAdversos.slice().reverse().map(x=>`<li class="row"><span>${x.medNombre}: ${x.efecto}</span></li>`).join('') : '<div class="muted">‚Äî vac√≠o ‚Äî</div>';
  }

// PRM (Beers/STOPP/START/Nefro/Embarazo + Interacciones + Duplicidades + Adherencia)
function computePRM(){
  if(!activeId || !DB) return;
  const f=FichasStore.get(activeId);
  const meds = getAllMeds(f);
  const bases = meds.map(x=> x.base);
  const set = new Set(bases);
  const out=[];

  // PPI (Beers/STOPP) agrupados, s√≥lo si +65
  if(f.age65){
    const ppiSet = new Set();
    meds.forEach(m=>{
      if(m.flags?.beers || m.flags?.stopp){ ppiSet.add(m.nombre); }
    });
    if(ppiSet.size){
      out.push({ tipo:"PPI (criterios Beers/STOPP)", 
        detalle: Array.from(ppiSet).map(n=>`‚Ä¢ ${n}`).join("<br>") });
    }
  }

  // START (desactivado por ahora)
  // Aqu√≠ no mostramos nada, ya que START deber√≠a dispararse s√≥lo si falta el f√°rmaco.
  // M√°s adelante se implementar√° con reglas externas.

  // Ajuste renal: s√≥lo si hay antecedente de ERC
  const erc = (f.anamnesis.antecedentes||[]).some(a=>/^ERC[2-5]/.test(a) || a.startsWith('ERC'));
  if(erc){
    const renales = meds.filter(m=> m.flags?.nefr);
    if(renales.length){
      out.push({ tipo:"Ajuste renal (ERC)", 
        detalle: renales.map(m=>`‚Ä¢ ${m.nombre} ‚Äî revisar ajuste seg√∫n VFG`).join("<br>") });
    }
  }

  // Embarazo: s√≥lo si mujer, <65 y marcado en anamnesis
  const isF = f.sexo==='F';
  const posibleEmbarazo = !!f.anamnesis?.embarazo; // necesitas el checkbox en anamnesis
  if(isF && !f.age65 && posibleEmbarazo){
    const riesgos = meds.filter(m=> !!m.flags?.embarazo);
    if(riesgos.length){
      out.push({ tipo:"Embarazo", 
        detalle: riesgos.map(m=>`‚Ä¢ ${m.nombre} (${m.flags.embarazo})`).join("<br>") });
    }
  }

  // Interacciones
  const pairs = DB.interacciones?.pairs||[];
  const ixs = pairs.filter(p=> set.has(p.a_base) && set.has(p.b_base));
  if(ixs.length) out.push({
    tipo:'Interacciones',
    detalle: ixs.map(p=>`‚Ä¢ ${p.a_base.toUpperCase()} + ${p.b_base.toUpperCase()}: <b>${p.severidad}</b> ‚Äî ${p.recomendacion}`).join("<br>")
  });

  // Duplicidades
  const dup = [...new Set(bases.filter((b,i,arr)=> arr.indexOf(b)!==i))];
  if(dup.length) out.push({tipo:'Duplicidades', detalle: dup.map(b=>`‚Ä¢ ${b.toUpperCase()}`).join("<br>")});

  // Adherencia
  const neg = (f.tests||[]).concat(f.calculos||[]).filter(x=>/no\s*adher/i.test(x.resultado||''));
  if(neg.length) out.push({tipo:'Adherencia', detalle: neg.map(x=>`‚Ä¢ ${x.tipo}: ${x.resultado}`).join("<br>")});

  // Guardar en la ficha
  FichasStore.update(activeId, ff=>{ ff.prm = out.length? out.map(x=>({...x,fecha:Date.now()})) : []; });
  renderPRM(FichasStore.get(activeId));
}

function renderPRM(f){
  const ul=$('#prm-list');
  ul.innerHTML = (f.prm&&f.prm.length)
    ? f.prm.slice().reverse().map(x=>`<li class="card"><b>${x.tipo}</b><div>${x.detalle}</div><div class="muted">${fmt(x.fecha)}</div></li>`).join('')
    : '<div class="muted">No se identifican o no se observan.</div>';
}

// ===== Helper: recorrer todos los medicamentos de la ficha
function getAllMeds(f){
  const meds = [];
  // APS / SEC
  (f.meds.apsRecetas||[]).forEach(r=>{
    (r.meds||[]).forEach(m=>{
      const sku = DBmeds?.skuById?.[m.sku];
      if(sku) meds.push({...m, nombre: sku.nombre, base: sku.base, flags: sku.flags||{}});
    });
  });
  (f.meds.secRecetas||[]).forEach(r=>{
    (r.meds||[]).forEach(m=>{
      const sku = DBmeds?.skuById?.[m.sku];
      if(sku) meds.push({...m, nombre: sku.nombre, base: sku.base, flags: sku.flags||{}});
    });
  });
  // Particular
  (f.meds.extra||[]).forEach(m=>{
    const sku = DBmeds?.skuById?.[m.sku];
    if(sku) meds.push({...m, nombre: sku.nombre, base: sku.base, flags: sku.flags||{}});
  });
  return meds;
}

  // V√≠nculos datos personales
  const fillVal=(id,v)=>{const el=document.getElementById(id); if(el) el.value=v??'';};
  const fillChk=(id,v)=>{const el=document.getElementById(id); if(el) el.checked=!!v;};
  function bindDatosPersonales(){
    const handler=debounce(()=>{ FichasStore.update(activeId, f=>{
      f.datos.acompana=val('dp-acomp'); f.datos.convive=val('dp-convive'); f.datos.conQuien=val('dp-conquien');
      f.datos.sector=val('dp-sector'); f.datos.ocupacion=val('dp-ocup'); f.datos.jubilacion=val('dp-jub');
      f.datos.analfabeto=chk('dp-ana'); f.datos.dependienteSevero=chk('dp-dep'); f.datos.ayudasTecnicas=chk('dp-ayt');
    }); },600);
    ['dp-acomp','dp-convive','dp-conquien','dp-sector','dp-ocup','dp-jub','dp-ana','dp-dep','dp-ayt'].forEach(id=>{
      const el=document.getElementById(id); el.oninput=handler; el.onchange=handler;
    });
  }
  const val=id=>document.getElementById(id)?.value||''; const chk=id=>!!document.getElementById(id)?.checked;

  // Cantidades seg√∫n forma
  function renderQtyUI(sku, container){
    const forma=sku?.forma || 'comprimido';
    const uid = container.id || (container.id='q'+Math.random().toString(36).slice(2,7));
    if(forma==='comprimido' || forma==='capsula'){
      container.innerHTML = `
        <label>Cantidad:
          <select id="${uid}-cant">
            <option>1/4</option><option>1/2</option><option>3/4</option>
            <option selected>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </label>
        <span class="soft">COMPRIMIDO(S)</span>
      `;
    }else if(forma==='suspension'){
      container.innerHTML = `<label>Cantidad: <input id="${uid}-ml" type="number" min="1" step="1" value="5" style="width:90px"></label><span class="soft">ML</span>`;
    }else if(forma==='inhalador'){
      container.innerHTML = `<label>Cantidad: <input id="${uid}-puff" type="number" min="1" step="1" value="2" style="width:90px"></label><span class="soft">PUFF</span>`;
    }else if(forma==='insulina'){
      container.innerHTML = `
        <label>AM: <input id="${uid}-am" type="number" min="0" step="1" value="0" style="width:90px"></label>
        <label>PM: <input id="${uid}-pm" type="number" min="0" step="1" value="0" style="width:90px"></label>
        <span class="soft">UI</span>
      `;
    }else{
      container.innerHTML = ``;
    }
  }

  window.openFicha = openFicha;

// ===== IMPORTAR RECETA RAYEN =====
const $modalRayen = document.getElementById('import-rayen-modal');
const $rayenInput = document.getElementById('rayen-input');

// === MAPAS / UTILIDADES PARA IMPORTAR RAYEN ===
const UNIDAD_POR_FORMA = {
  "COMPRIMIDO": "COMP",
  "COMPRIMIDO LP": "COMP",
  "CAPSULA": "CAP",
  "UI": "UI",
  "UNIDAD": "UNIDAD",
  "DOSIS": "DOSIS",
  "INHALADOR": "PUFF",           // si posolog√≠a dice "dosis/disparo" ‚Üí DOSIS
  "GOTAS": "GTS",
  "SUSPENSI√ìN ORAL": "ML",
  "SUSPENSION ORAL": "ML",
  "JARABE": "ML",
  "AMPOLLA": "DOSIS",
  "SOLUCI√ìN ORAL": "ML",
  "SOLUCION ORAL": "ML",
  "SOLUCI√ìN OFT√ÅLMICA": "GTS",
  "SOLUCION OFTALMICA": "GTS",
  "GEL": "UNIDAD",
  "CREMA": "UNIDAD",
  "UNGUENTO": "UNIDAD",
  "UNG√úENTO": "UNIDAD",
  "SUPOSITORIO": "SUP",
  "JERINGA": "DOSIS",
  "PARCHE": "UNIDAD"
};

const sinAcentos = s => (s || "").normalize("NFD").replace(/\p{Diacritic}/gu, "");
const normNombre = (s="") => sinAcentos(s.toUpperCase())
  .replace(/\b(RECUBIERT[OA]S?)\b/g, "")
  .replace(/\b(DE\s+)?LIBERACION\s+PROLONGADA\b/g, "LP")
  .replace(/\b(POTASIC[OA]|SODIC[OA]|CLORHIDRATO|SULFATO)\b/g, "")
  .replace(/\bCOMPRIMIDOS?\b/g, "COMPRIMIDO")
  .replace(/\bC[√ÅA]PSULAS?\b/g, "CAPSULA")
  .replace(/[().,:]/g, " ")
  .replace(/\s+/g, " ")
  .trim();

function unidadDesdePosologia(poso="") {
  const t = sinAcentos(poso.toLowerCase());
  if (/\b(puffs?|disparos?)\b/.test(t)) return "PUFF";
  if (/\bdosis\b/.test(t)) return "DOSIS";
  if (/\bgotas?\b/.test(t)) return "GTS";
  if (/\bml|mililitros?\b/.test(t)) return "ML";
  if (/\bui|u\.?i\.?\b/.test(t)) return "UI";
  if (/\bsupositorios?\b/.test(t)) return "SUP";
  if (/\bcomprimidos?\b/.test(t)) return "COMP";
  if (/\bcapsulas?\b/.test(t)) return "CAP";
  if (/\bunidades?|aplicaciones?|parches?\b/.test(t)) return "UNIDAD";
  return null;
}

function unidadPorForma(formJson = "", poso="") {
  const f = sinAcentos(formJson.toUpperCase());
  let unidad = UNIDAD_POR_FORMA[f] || "UNIDAD";
  if (f === "INHALADOR") {
    const t = sinAcentos(poso.toLowerCase());
    if (/\bdosis|disparos?\b/.test(t)) unidad = "DOSIS";
    else if (/\bpuffs?\b/.test(t)) unidad = "PUFF";
  }
  const uPoso = unidadDesdePosologia(poso);
  return uPoso || unidad;
}

function extraerCantidad(poso="") {
  const m = poso.match(/(\d+[.,]?\d*)\s*(comprimidos?|capsulas?|puffs?|disparos?|dosis|gotas?|ml|mililitros?|ui|u\.?i\.?|supositorios?|unidades?|parches?)/i)
           || poso.match(/\b(\d+[.,]?\d*)\b/);
  if (!m) return 1;
  return parseFloat(m[1].replace(",", "."));
}

function normalizarFrecuencia(poso="") {
  if (/\bS\.?O\.?S\.?\b/i.test(poso) || /\bA\s*DEMANDA\b/i.test(poso)) return "SOS";
  const m = poso.match(/(?:cada|c\/|q)\s*(\d+)\s*(h|hr|hrs|hora|horas|d|dia|dias)/i);
  if (!m) return "CADA 24 HORAS";
  const n = parseInt(m[1], 10);
  const u = m[2].toLowerCase();
  return (u.startsWith("d")) ? "CADA 24 HORAS" : `CADA ${n} HORAS`;
}

document.getElementById('btn-import-rayen').onclick = ()=>{
  $modalRayen.style.display = 'flex';
};
document.getElementById('rayen-cancel').onclick = ()=>{
  $modalRayen.style.display = 'none';
  $rayenInput.value='';
};

document.getElementById('rayen-process').onclick = ()=>{
  const raw = $rayenInput.value.trim();
  if(!raw){ alert("Pega el texto de Rayen primero."); return; }
  if(!activeId){ alert("Debes tener una ficha abierta."); return; }
  if(!window.DBmeds || !window.DBmeds.skus?.length){
    alert("‚ùå La base de medicamentos no est√° cargada.");
    return;
  }

  const lines = raw.split("\n").map(l=>l.trim()).filter(l=>l);

  // === Fecha opcional (si primera l√≠nea es dd-mm-aaaa) ===
  let startIdx = 0;
  let fechaISO = new Date().toISOString().slice(0,10);
  const mFecha = lines[0]?.match(/\b(\d{2})-(\d{2})-(\d{4})\b/);
  if (mFecha) {
    const [_, dd, mm, yyyy] = mFecha;
    fechaISO = `${yyyy}-${mm}-${dd}`;
    startIdx = 1;
  }

  // === Receta base ===
  const recetaId = 'R'+Math.random().toString(36).slice(2,7).toUpperCase();
  const receta = { id:recetaId, fechaISO, meses:12, meds:[] };

  // === Iterar medicamentos ===
  for (let i = startIdx; i < lines.length; i++) {
    const row = lines[i];
    const m = row.match(/^\(\d+\)\s+(.+?):\s+(.+)$/);
    if (!m) continue;

    const nombreRayenRaw = m[1].trim();
    const posoRaw = m[2].trim();
    const nombreRayen = normNombre(nombreRayenRaw);

    // Limpiar posolog√≠a
    let posoLimpio = posoRaw
      .replace(/por\s+\d+\s*(d[i√≠]as?|mes(?:es)?)/i, "")
      .replace(/de\s+la\s+Receta\s+N¬∫\s+\d+/i, "")
      .trim();

    // Duraci√≥n de la receta (para toda la receta)
    let meses = 12;
    const mMes = posoRaw.match(/(\d+)\s*mes/i);
    if (mMes) meses = Math.min(12, parseInt(mMes[1], 10));
    else {
      const mDia = posoRaw.match(/(\d+)\s*d[i√≠]as?/i);
      if (mDia) meses = Math.min(12, Math.max(1, Math.round(parseInt(mDia[1],10)/30)));
    }
    receta.meses = meses;

    // === Match flexible con DB: BASE + FUERZA + FORMA ===
    const candidatos = window.DBmeds.skus.filter(sku=>{
      const baseOK   = nombreRayen.includes(sku.base.toUpperCase());
      const fuerzaOK = sku.raw?.FUERZA ? nombreRayen.includes(normNombre(sku.raw.FUERZA)) : true;
      const formaJson = (sku.raw?.FORMA || "").toUpperCase();
      const formaOK   = formaJson ? nombreRayen.includes(normNombre(formaJson)) : true;
      return baseOK && fuerzaOK && formaOK;
    });
    const match = candidatos[0];
    if(!match){
      console.log("‚ùå No se encontr√≥ en base:", nombreRayenRaw);
      continue; // si no hay match, no se incluye
    }

    // === Cantidad, Unidad y Frecuencia ===
    const cantidad = extraerCantidad(posoLimpio);
    const unidad   = unidadPorForma(match.raw?.FORMA || match.forma, posoLimpio);
    const cada     = normalizarFrecuencia(posoLimpio);

    // === Guardar con SKU oficial y nombre formateado de tu base ===
const display = `${match.nombre} ${cantidad} ${unidad} ${cada}`.replace(/\s+/g,' ').trim();

receta.meds.push({
  id: crypto.randomUUID(),
  sku: match.skuId,
  base: match.base.toUpperCase(),
  nombre: display,                       // ya incluye 1 COMP / 2 GTS / CADA ...
  forma: (match.raw?.FORMA || match.forma || '').toString().toUpperCase(),
  cantidad, unidad, cada,
  posologia: "",                         // <- vac√≠o para no duplicar
  posologiaRayen: posoLimpio             // <- respaldo opcional
});

  }

  // === Persistir en la ficha ===
  FichasStore.update(activeId, f=>{
    if(!f.meds.apsRecetas) f.meds.apsRecetas=[];
    f.meds.apsRecetas.push(receta);
  });
  renderRecetas("apsRecetas","#aps-recetas");
  computePRM();

  // Cerrar modal
  $modalRayen.style.display = 'none';
  $rayenInput.value = '';
  alert("‚úÖ Receta importada correctamente desde Rayen");
};

</script>
</body>
</html>
