<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO â€” VademÃ©cum</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">VademÃ©cum</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">ğŸ·ï¸ Inicio</a>
      <a class="nav-item" href="atencion.html">ğŸ§‘â€âš•ï¸ AtenciÃ³n farmacÃ©utica</a>
      <a class="nav-item" href="generador.html">ğŸ“ Generador de texto</a>
      <a class="nav-item active" href="vademecum.html">ğŸ’Š VademÃ©cum</a>
      <a class="nav-item" href="material.html">ğŸ“š Material de consulta</a>
      <a class="nav-item" href="herramientas.html">ğŸ§° Herramientas</a>
      <a class="nav-item" href="proa.html">ğŸ§ª PROA</a>
      <a class="nav-item" href="plantas.html">ğŸŒ¿ Plantas medicinales</a>
      <a class="nav-item" href="protocolos.html">ğŸ“‘ Orientaciones tÃ©cnicas</a>
      <a class="nav-item" href="config.html">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>
    <main class="container">
      <div class="row" style="gap:8px">
        <input id="q" placeholder="Buscar medicamentoâ€¦ (ej: losartan)">
        <button id="go" class="btn">Buscar</button>
      </div>
      <div id="list" class="list" style="margin-top:12px"></div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { loadAll } from "../js/medStore.js";
  mountHeader();

  const $q = document.getElementById("q");
  const $go = document.getElementById("go");
  const $list = document.getElementById("list");
  const params = new URLSearchParams(location.search);
  if (params.get("q")) $q.value = params.get("q");

  let DB = null;
  let INTERACCIONES = [];

  const normalizar = (txt = "") =>
    txt
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .trim();

  function participaEnInteraccion(med, interaccion) {
    const baseMed = normalizar(med.base || med.nombre || med.id || "");
    if (!baseMed) return false;
    const grupos = [interaccion.grupo_1, interaccion.grupo_2, interaccion.grupo_3].filter(Boolean);
    return grupos.some((grupo) =>
      (grupo?.medicamentos || []).some((nombre) => normalizar(nombre) === baseMed)
    );
  }

  function renderInteraccionDetalle(interaccion) {
    const grupos = [interaccion.grupo_1, interaccion.grupo_2, interaccion.grupo_3].filter(Boolean);
    const titulo = grupos.map((g) => g?.nombre || "Grupo").join(" + ");
    const listado = grupos
      .map((g) => {
        const meds = (g?.medicamentos || []).map((m) => m.toUpperCase()).join(", ");
        return `${g?.nombre || "Grupo"}: ${meds}`;
      })
      .filter(Boolean)
      .join(" Â· ");
    const comentario = interaccion.comentario ? `<div>${interaccion.comentario}</div>` : "";
    const mecanismo = interaccion.mecanismo
      ? `<div class="muted" style="margin-top:4px">${interaccion.mecanismo}</div>`
      : "";
    const gruposTexto = listado
      ? `<div class="muted" style="margin-top:6px;font-size:12px;">Incluye: ${listado}</div>`
      : "";
    return `
      <li class="card">
        <div><b>${titulo}</b></div>
        ${comentario}
        ${mecanismo}
        ${gruposTexto}
      </li>`;
  }

  function render(items) {
    const beers = DB.criterios?.beers || [];
    const stopp = DB.criterios?.stopp || [];

    $list.innerHTML =
      items
        .map((m) => {
          const ix = INTERACCIONES.filter((registro) => participaEnInteraccion(m, registro));
          const cb = beers.filter((c) => (c.afecta || []).includes(m.id));
          const cs = stopp.filter((c) => (c.afecta || []).includes(m.id));

          return `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <b>${m.nombre}</b>
            ${(m.aware ? `<span class="pill">${m.aware}</span>` : "")}
          </div>
          <div class="muted">${(m.etiquetas || []).join(", ")}</div>
        </div>

        ${ix.length
          ? `
          <div style="margin-top:8px">
            <div class="muted">Interacciones relevantes:</div>
            <ul class="list" style="margin-top:6px">
              ${ix.map((registro) => renderInteraccionDetalle(registro)).join("")}
            </ul>
          </div>`
          : ""}

        ${(cb.length || cs.length)
          ? `
          <div style="margin-top:8px">
            <div class="muted">Criterios STOPP/Beers:</div>
            <ul class="list" style="margin-top:6px">
              ${cb
                .map(
                  (c) =>
                    `<li class="card"><b>Beers:</b> ${c.titulo}<br><span class="muted">${c.motivo}</span><br>${c.accion}</li>`
                )
                .join("")}
              ${cs
                .map(
                  (c) =>
                    `<li class="card"><b>STOPP:</b> ${c.titulo}<br><span class="muted">${c.motivo}</span><br>${c.accion}</li>`
                )
                .join("")}
            </ul>
          </div>`
          : ""}
      </div>`;
        })
        .join("") || '<div class="card muted">â€” sin resultados â€”</div>';
  }

  async function init() {
    try {
      const [db, interData, criterios] = await Promise.all([
        loadAll(),
        fetch("../data/interacciones.json")
          .then((r) => r.json())
          .catch(() => ({ interacciones: [] })),
        fetch("../data/criterios.json")
          .then((r) => r.json())
          .catch(() => null),
      ]);

      DB = db || { meds: {} };
      if (criterios) DB.criterios = criterios;
      INTERACCIONES = Array.isArray(interData)
        ? interData
        : interData?.interacciones || [];

      const all = Object.values(DB.meds || {});
      render(all);
      if ($q.value) $go.click();
    } catch (err) {
      console.error("âŒ Error inicializando vademÃ©cum:", err);
    }
  }

  init();

  $go.onclick = () => {
    const txt = ($q.value || "").toLowerCase();
    const res = Object.values(DB.meds || {}).filter(
      (m) =>
        m.nombre.toLowerCase().includes(txt) ||
        (m.etiquetas || []).some((t) => t.toLowerCase().includes(txt)) ||
        m.id.toLowerCase().includes(txt)
    );
    render(res);
  };
</script>
</body>
</html>