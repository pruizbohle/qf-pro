<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO — Vademécum</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Vademécum</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">🏷️ Inicio</a>
      <a class="nav-item" href="atencion.html">🧑‍⚕️ Atención farmacéutica</a>
      <a class="nav-item" href="generador.html">📝 Generador de texto</a>
      <a class="nav-item active" href="vademecum.html">💊 Vademécum</a>
      <a class="nav-item" href="material.html">📚 Material de consulta</a>
      <a class="nav-item" href="herramientas.html">🧰 Herramientas</a>
      <a class="nav-item" href="proa.html">🧪 PROA</a>
      <a class="nav-item" href="plantas.html">🌿 Plantas medicinales</a>
      <a class="nav-item" href="protocolos.html">📑 Orientaciones técnicas</a>
      <a class="nav-item" href="config.html">⚙️ Configuración</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>
    <main class="container">
      <div class="row" style="gap:8px">
        <input id="q" placeholder="Buscar medicamento… (ej: losartan)">
        <button id="go" class="btn">Buscar</button>
      </div>
      <div id="list" class="list" style="margin-top:12px"></div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { loadAll } from "../js/medStore.js";
  mountHeader();

  const $q=document.getElementById('q'), $go=document.getElementById('go'), $list=document.getElementById('list');
  const params=new URLSearchParams(location.search); if(params.get('q')) $q.value=params.get('q');

  let DB=null;

  function render(items){
    const inter = DB.interacciones?.pairs || [];
    const beers = DB.criterios?.beers || [];
    const stopp = DB.criterios?.stopp || [];

    $list.innerHTML = items.map(m=>{
      // Interacciones que involucren este fármaco
      const ix = inter.filter(p => p.a===m.id || p.b===m.id);
      // Criterios que lo mencionen
      const cb = beers.filter(c => (c.afecta||[]).includes(m.id));
      const cs = stopp.filter(c => (c.afecta||[]).includes(m.id));

      return `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <b>${m.nombre}</b>
            ${(m.aware?`<span class="pill">${m.aware}</span>`:'')}
          </div>
          <div class="muted">${(m.etiquetas||[]).join(", ")}</div>
        </div>

        ${ix.length ? `
          <div style="margin-top:8px">
            <div class="muted">Interacciones relevantes:</div>
            <ul class="list" style="margin-top:6px">
              ${ix.map(p=>{
                const otra = (p.a===m.id) ? p.b : p.a;
                const nOtra = DB.meds[otra]?.nombre || otra;
                return `<li class="card">
                  <div><b>${nOtra}</b> — <span class="pill">${p.severidad}</span></div>
                  <div class="muted">${p.mecanismo}</div>
                  <div>${p.recomendacion}</div>
                </li>`;
              }).join("")}
            </ul>
          </div>` : ``}

        ${(cb.length||cs.length) ? `
          <div style="margin-top:8px">
            <div class="muted">Criterios STOPP/Beers:</div>
            <ul class="list" style="margin-top:6px">
              ${cb.map(c=>`<li class="card"><b>Beers:</b> ${c.titulo}<br><span class="muted">${c.motivo}</span><br>${c.accion}</li>`).join("")}
              ${cs.map(c=>`<li class="card"><b>STOPP:</b> ${c.titulo}<br><span class="muted">${c.motivo}</span><br>${c.accion}</li>`).join("")}
            </ul>
          </div>` : ``}
      </div>`;
    }).join('') || '<div class="card muted">— sin resultados —</div>';
  }

  loadAll().then(db=>{
    DB=db;
    const all=Object.values(DB.meds);
    render(all);
    if($q.value) $go.click();
  });

  $go.onclick=()=>{
    const txt=($q.value||'').toLowerCase();
    const res=Object.values(DB.meds).filter(m=>
      m.nombre.toLowerCase().includes(txt) ||
      (m.etiquetas||[]).some(t=>t.toLowerCase().includes(txt)) ||
      m.id.toLowerCase().includes(txt)
    );
    render(res);
  };
</script>
</body>
</html>
