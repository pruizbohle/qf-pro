<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO â€” Generador</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Generador</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">ğŸ·ï¸ Inicio</a>
      <a class="nav-item" href="atencion.html">ğŸ§‘â€âš•ï¸ AtenciÃ³n farmacÃ©utica</a>
      <a class="nav-item active" href="generador.html">ğŸ“ Generador de texto</a>
      <a class="nav-item" href="vademecum.html">ğŸ’Š VademÃ©cum</a>
      <a class="nav-item" href="material.html">ğŸ“š Material de consulta</a>
      <a class="nav-item" href="herramientas.html">ğŸ§° Herramientas</a>
      <a class="nav-item" href="proa.html">ğŸ§ª PROA</a>
      <a class="nav-item" href="plantas.html">ğŸŒ¿ Plantas medicinales</a>
      <a class="nav-item" href="protocolos.html">ğŸ“‘ Orientaciones tÃ©cnicas</a>
      <a class="nav-item" href="config.html">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>
    <main class="container">
      <div class="row" style="gap:8px">
        <label>Ficha:
          <select id="sel-ficha"></select>
        </label>
        <button id="btn-compilar" class="btn">Compilar</button>
      </div>
      <div class="card" style="margin-top:10px">
        <textarea id="texto" rows="18" style="width:100%" placeholder="Texto listo para ficha clÃ­nicaâ€¦"></textarea>
      </div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { FichasStore } from "../js/fichasStore.js";
  mountHeader();

  const $sel=document.getElementById('sel-ficha'), $txt=document.getElementById('texto'), $btn=document.getElementById('btn-compilar');

  function loadFichas(){
    const L=FichasStore.list();
    $sel.innerHTML = `<option value="">â€” Selecciona â€”</option>` + L.map(f=>`<option value="${f.id}">${f.id}</option>`).join("");
    const h=(location.hash||'').replace('#','').toUpperCase(); if(h) $sel.value=h;
  }

  const mapAnt = x => x; // ya vienen en bonito: HTA, DM2 IR, etc.

  const lineDiagnosticos = (f) => {
    const diag = f.anamnesis.antecedentes?.length
      ? f.anamnesis.antecedentes.map(mapAnt).join(", ")
      : "sin registro";
    return `- Usuario con diagnÃ³sticos de ${diag}.`;
  };

  const lineAntecedentesRelevantes = (f) => {
    const flags = f.anamnesis.flags || {};
    const lista = [];
    if (flags.antIAMACV) lista.push("IAM/ACV");
    if (flags.erc) lista.push("ERC");
    if (!lista.length) return "";
    return `- Usuario con antecedentes de ${lista.join(", ")}.`;
  };

  const linePDC = (f) => {
    const pdc = f.anamnesis.adherencia?.pdc || "sin registro";
    return `- Adherencia segÃºn PDC: ${pdc}.`;
  };

  function paraAntecedentes(f) {
    const lines = [
      "ANTECEDENTES",
      lineDiagnosticos(f),
      lineAntecedentesRelevantes(f),
      linePDC(f),
    ].filter(Boolean);
    return lines.join("\n");
  }

  const formatearCantidad = (item) => {
    const nombreUpper = (item.nombre || "").toUpperCase();
    const yaPos = /\b(CADA|SOS)\b/.test(nombreUpper);
    if (yaPos) return "";
    if ((item.forma || "").toLowerCase() === "insulina") {
      return ` ${item.uiAm || 0} UI AM - ${item.uiPm || 0} UI PM`;
    }
    if (item.cantidad) return ` ${item.cantidad} ${item.unidad || ""}`;
    return "";
  };

  const formatearMed = (item) => {
    const nombre = (item.nombre || item.base || "").trim();
    const cantidad = formatearCantidad(item);
    const posologia = item.posologia ? ` ${item.posologia}` : "";
    return `${nombre}${cantidad}${posologia}`.trim();
  };

  const lineaRecetas = (label, recetas = []) => {
    const meds = recetas.flatMap((r) => r?.meds || []);
    if (!meds.length) return "";
    return `- ${label}: ${meds.map(formatearMed).join("; ")}.`;
  };

  function paraMeds(f) {
    const aps = lineaRecetas("APS", f.meds?.apsRecetas || []);
    const sec = lineaRecetas("Secundario", f.meds?.secRecetas || []);
    const cuerpo = [aps, sec].filter(Boolean);
    if (!cuerpo.length) return "";
    return ["MEDICACION", ...cuerpo].join("\n");
  }
  
  function paraPRM(f) {
    const prm = Array.isArray(f.prm) ? f.prm : [];
    if (!prm.length) return "PRM\nNo se identifican o no se observan.";

    const cat = { dup: [], ppi: [], inter: [], otros: [] };
    prm.forEach((p) => {
      const tipo = (p.tipo || "").toUpperCase();
      const detalle = (p.detalle || "").replace(/<br>/g, "; ").trim();
      const texto = detalle || p.tipo || "PRM";
      if (/DUPLIC/.test(tipo)) cat.dup.push(texto);
      else if (/PPI/.test(tipo)) cat.ppi.push(texto);
      else if (/INTERAC/.test(tipo)) cat.inter.push(texto);
      else cat.otros.push(texto);
    });

    const lines = ["PRM"];
    const add = (titulo, arr) => {
      if (!arr.length) return;
      lines.push(titulo, ...arr.map((t) => `- ${t}`));
    };
    add("DUPLICIDADES", cat.dup);
    add("CRITERIOS PPI", cat.ppi);
    add("INTERACCIONES", cat.inter);
    add("OTROS", cat.otros);

    if (lines.length === 1) return "PRM\nNo se identifican o no se observan.";
    return lines.join("\n");
  }

  function paraComentarios(f) {
    const lista = [f.notas, f.anamnesis?.textoLibre].filter(Boolean);
    if (!lista.length) return "";
    return ["COMENTARIOS", ...lista.map((t) => `- ${t}`)].join("\n");
  }

  $btn.onclick=()=>{
    const id=$sel.value; if(!id) return;
    const f=FichasStore.get(id); if(!f) return;
    const lines=[paraAntecedentes(f), paraMeds(f), paraPRM(f), paraComentarios(f)].filter(Boolean).join("\n\n");
    $txt.value = lines;
  };

  loadFichas();
</script>
</body>
</html>