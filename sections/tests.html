<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO — Tests</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Tests</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">🏷️ Inicio</a>
      <a class="nav-item" href="atencion.html">🧑‍⚕️ Atención</a>
      <a class="nav-item" href="tests.html">🧪 Tests</a>
      <a class="nav-item" href="calculadoras.html">🧮 Calculadoras</a>
      <a class="nav-item" href="material.html">📚 Material de consulta</a>
      <a class="nav-item" href="proa.html">🧫 PROA</a>
      <a class="nav-item" href="config.html">⚙️ Configuración</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>
    <main class="container">
      <div class="row" style="gap:8px">
        <label>Modo:
          <select id="modo">
            <option value="libre">Libre</option>
            <option value="ficha">Asociado a ficha…</option>
          </select>
        </label>
        <select id="sel-ficha" style="display:none"></select>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Morisky-Green (4 ítems)</h3>
        <div class="row" style="gap:6px;flex-direction:column">
          <label class="pick"><input type="checkbox" class="mg" data-q="1"> ¿Se olvida alguna vez de tomar sus medicamentos?</label>
          <label class="pick"><input type="checkbox" class="mg" data-q="2"> ¿Es descuidado/a a veces con la hora de tomar sus medicamentos?</label>
          <label class="pick"><input type="checkbox" class="mg" data-q="3"> Cuando se siente mejor, ¿deja a veces de tomar sus medicamentos?</label>
          <label class="pick"><input type="checkbox" class="mg" data-q="4"> Si se siente peor por el medicamento, ¿deja a veces de tomarlo?</label>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="mg-calc" class="btn">Calcular</button>
          <span id="mg-out" class="pill"></span>
          <button id="mg-save" class="btn" disabled>Guardar en ficha</button>
        </div>
        <div id="out" class="list" style="margin-top:10px"></div>
      </div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { FichasStore } from "../js/fichasStore.js";
  mountHeader();

  const $modo=document.getElementById('modo'), $sel=document.getElementById('sel-ficha');
  const $out=document.getElementById('out');

  function refresh(){ $sel.innerHTML=FichasStore.list().map(f=>`<option>${f.id}</option>`).join(""); }
  $modo.onchange=()=>{ $sel.style.display=$modo.value==='ficha'?'inline-block':'none'; if($modo.value==='ficha') refresh(); };

  document.getElementById('mg-calc').onclick=()=>{
    const n = Array.from(document.querySelectorAll('.mg')).filter(x=>x.checked).length;
    const clas = (n===0)?'Adherente':(n<=2?'Parcialmente adherente':'No adherente');
    document.getElementById('mg-out').textContent = `Morisky-Green: ${clas} (${n}/4)`;
    document.getElementById('mg-save').disabled = false;
  };

  document.getElementById('mg-save').onclick=()=>{
    if($modo.value!=='ficha' || !$sel.value) return;
    const txt = document.getElementById('mg-out').textContent || ''; if(!txt) return;
    FichasStore.update($sel.value, f=> f.tests.push({ tipo:'Morisky-Green', resultado: txt, fecha: Date.now(), asociado:true }));
    $out.innerHTML = `<div class="card">💾 Guardado en ficha ${$sel.value}: ${txt}</div>` + $out.innerHTML;
    document.getElementById('mg-save').disabled = true;
  };
</script>
</body>
</html>
