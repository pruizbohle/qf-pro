<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QF PRO ‚Äî Atenci√≥n farmac√©utica</title>
  <!-- Tu hoja de estilos global -->
  <link rel="stylesheet" href="../css/styles.css"/>
  <style>
    /* ===== Ajustes m√≠nimos locales: no pisan tu styles.css ===== */
    .tabs-row{display:flex;margin-left:8px;gap:10px;flex-wrap:wrap;margin:10px 0 8px}
    .tab-btn{border:1px solid rgba(148,163,184,.18);background:transparent;color:#d1d5db;border-radius:999px;padding:6px 10px;cursor:pointer}
    .tab-btn.active{background:#0c172c;border-color:rgba(148,163,184,.35)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:center}
    .grid3{display:grid;grid-template-columns:1fr 280px;gap:24px;align-items:flex-start}
    .card{background:#0c172c;border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:12px}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#0b74d1;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px}
    .chip.warn{background:#ff9800;color:#111}
    .btn-lg{display:block;width:100%;padding:10px 14px;border:1px solid rgba(148,163,184,.3);border-radius:8px;background:#101c33;color:#e5e7eb;text-align:center;transition:background .2s}
    .btn-lg:hover{background:#15274a}
    .btn.mini{padding:4px 8px;font-size:12px}
    .muted{color:#8a8b9a}
    .seg-title{font-weight:700;margin-bottom:6px}
    .fichas-panel{border-left:1px solid rgba(148,163,184,0.2);padding-left:16px}
    .fichas-lista{display:flex;flex-direction:column;gap:10px}
    .ficha-card{background:#101c33;border:1px solid rgba(148,163,184,.3);border-radius:8px;padding:10px 12px}
    .ficha-card.active{border-color:#0b74d1;box-shadow:0 0 0 1px rgba(11,116,209,.3)}
    .trash{cursor:pointer;opacity:0.8}
    #header-paciente{font-weight:600;margin:6px 0 4px 0}
    [data-panel]{display:none}
  </style>
</head>
<body>
<div class="app">
  <!-- ======== SIDEBAR (se mantiene tu navegaci√≥n) ======== -->
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Atenci√≥n</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">üè∑Ô∏è Inicio</a>
      <a class="nav-item active" href="atencion.html">üßë‚Äç‚öïÔ∏è Atenci√≥n farmac√©utica</a>
      <a class="nav-item" href="generador.html">üìù Generador de texto</a>
      <a class="nav-item" href="vademecum.html">üíä Vadem√©cum</a>
      <a class="nav-item" href="material.html">üìö Material de consulta</a>
      <a class="nav-item" href="herramientas.html">üß∞ Herramientas</a>
      <a class="nav-item" href="proa.html">üß™ PROA</a>
      <a class="nav-item" href="plantas.html">üåø Plantas medicinales</a>
      <a class="nav-item" href="protocolos.html">üìë Orientaciones t√©cnicas</a>
      <a class="nav-item" href="config.html">‚öôÔ∏è Configuraci√≥n</a>
    </nav>
  </aside>

  <!-- ======== MAIN ======== -->
  <main class="main">
    <!-- Header global montado por header.js -->
    <div id="header"></div>

    <!-- T√≠tulo din√°mico de ficha activa (iniciales ¬∑ sexo ¬∑ edad) -->
    <div id="header-paciente" style="display:none;margin-left:8px;"></div>

    <!-- ===== NAV TABS (controladas por tipo de atenci√≥n) ===== -->
    <div class="tabs-row" id="tabs">
      <button class="tab-btn active" data-tab="ficha">CREAR FICHA</button>
      <button class="tab-btn" data-tab="ante">ANTECEDENTES</button>
      <button class="tab-btn" data-tab="anam">ANAMNESIS</button>
      <button class="tab-btn" data-tab="meds">MEDICAMENTOS</button>
      <button class="tab-btn" data-tab="ea">Reacciones adversas</button>
      <button class="tab-btn" data-tab="prm">PRM</button>
      <button class="tab-btn" data-tab="edu">EDUCACI√ìN</button>
      <button class="tab-btn" data-tab="herr">HERRAMIENTAS</button>
      <button class="tab-btn" data-tab="indi">INDICACIONES</button>
      <button class="tab-btn" data-tab="acu">ACUERDOS</button>
    </div>

    <!-- ===== CONTENIDO PRINCIPAL + PANEL LATERAL ===== -->
    <div class="grid3">
      <section class="content col" style="gap:12px">

        <!-- ====== PANEL CREAR FICHA ====== -->
        <div id="panel-ficha" data-panel class="card" style="display:block">
          <div class="seg-title">CREAR FICHA</div>

          <div class="grid2" style="margin-top:10px;">
            <!-- Imagen izquierda -->
            <div style="text-align:center;">
              <img src="../img/ficha.png" alt="Creaci√≥n de ficha" style="width:260px;max-width:90%;height:auto;"/>
            </div>
            <!-- Formulario derecha -->
            <div>
              <div class="row" style="margin-bottom:8px;">
                <label>Iniciales:
                  <input id="ini" maxlength="6" placeholder="ABC" style="width:90px; text-transform:uppercase;"/>
                </label>
<label>‚â•65:
  <input id="mayor65" type="checkbox"/>
</label>

                <label>Sexo:
                  <select id="sexo">
                    <option value="">‚Äî</option>
                    <option value="F">‚ôÄ F</option>
                    <option value="M">‚ôÇ M</option>
                  </select>
                </label>
                <button id="btn-crear" class="btn">CREAR</button>
              </div>

              <!-- Chips -->
              <div class="row" id="chips-area" style="margin-top:4px;">
                <span id="chip-65" class="chip" style="display:none;">‚â•65 (PPI)</span>
                <span id="chip-emb" class="chip warn" style="display:none;">Seguridad en embarazo</span>
              </div>

              <!-- Tipos de atenci√≥n -->
              <div class="col" style="gap:8px;margin-top:12px;">
                <button class="btn-lg" id="tipo-sinconc">SIN ENTREVISTA: CONCILIACI√ìN</button>
                <button class="btn-lg" id="tipo-sinram">SIN ENTREVISTA: RAM</button>
                <button class="btn-lg" id="tipo-conreg">CON ENTREVISTA: REGULAR</button>
                <button class="btn-lg" id="tipo-conmais">CON ENTREVISTA: AMPLIADA</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ====== PANELS DE CONTENIDO ====== -->
        <div id="panel-ante" data-panel class="card">
          <div class="seg-title">ANTECEDENTES</div>
          <div class="row">
            <input id="ant-input" list="ant-suggest" placeholder="Escribe un antecedente y presiona Enter‚Ä¶"/>
            <datalist id="ant-suggest"></datalist>
            <div id="ant-list" class="row" style="gap:6px"></div>
          </div>
          <div class="row" style="gap:12px;margin-top:8px">
            <label class="pick mini"><input type="checkbox" id="ant-iamacv"> ANT IAM/ACV</label>
            <label class="pick mini"><input type="checkbox" id="ant-erc"> ERC</label>
            <label class="pick mini" id="wrap-embarazo" style="display:none"><input type="checkbox" id="ant-embarazo"> Embarazo</label>
          </div>
        </div>

        <div id="panel-anam" data-panel class="card">
          <div class="seg-title">ANAMNESIS</div>
          <div class="muted">Completar motivo de consulta, s√≠ntomas, escalas aplicadas, etc.</div>
        </div>

        <div id="panel-meds" data-panel class="card">
          <div class="seg-title">MEDICAMENTOS</div>
          <h3>1Ô∏è‚É£ Recetas APS</h3>
          <div id="aps-recetas"></div>
          <div data-sub="extra" style="display:none;margin-top:8px">
            <h4 class="muted">Recetas privadas</h4>
            <div id="rec-privadas" class="row"></div>
            <h4 class="muted" style="margin-top:8px">Automedicaci√≥n</h4>
            <div id="rec-automed" class="row"></div>
            <h4 class="muted" style="margin-top:8px">Plantas medicinales</h4>
            <div id="rec-plantas" class="row"></div>
          </div>
          <h3 style="margin-top:12px">2Ô∏è‚É£ Conciliaci√≥n</h3>
          <ul id="conciliacion-list"></ul>
          <button id="btn-conciliar" class="btn">Marcar como conciliado</button>

          <h3 style="margin-top:12px">3Ô∏è‚É£ Errores de medicaci√≥n</h3>
          <div class="row">
            <select id="err-etapa">
              <option value="">Etapa‚Ä¶</option>
              <option>Prescripci√≥n</option>
              <option>Transcripci√≥n</option>
              <option>Dispensaci√≥n</option>
              <option>Administraci√≥n</option>
              <option>Monitorizaci√≥n</option>
            </select>
            <input id="err-desc" placeholder="Descripci√≥n breve"/>
            <button id="err-add" class="btn">Agregar</button>
          </div>
          <ul id="errores-list"></ul>
        </div>

        <div id="panel-ea" data-panel class="card">
          <div class="seg-title">Reacciones adversas (RAM)</div>
          <div id="ea-out" class="row"></div>
        </div>

        <div id="panel-prm" data-panel class="card">
          <div class="seg-title">PRM</div>
          <div id="prm-auto"></div>
          <div class="muted">Se completa autom√°ticamente desde Medicaci√≥n, Conciliaci√≥n y RAM.</div>
        </div>

        <div id="panel-edu" data-panel class="card">
          <div class="seg-title">EDUCACI√ìN</div>
          <div id="edu-out" class="muted">‚Äî Sin contenidos a√∫n ‚Äî</div>
        </div>

        <div id="panel-herr" data-panel class="card">
          <div class="seg-title">HERRAMIENTAS (Tests + Calculadoras)</div>
          <div id="herr-out" class="muted">‚Äî Sin resultados a√∫n ‚Äî</div>
        </div>

        <div id="panel-indi" data-panel class="card">
          <div class="seg-title">INDICACIONES</div>
          <div id="ind-out" class="muted">‚Äî Sin contenidos a√∫n ‚Äî</div>
        </div>

        <div id="panel-acu" data-panel class="card">
          <div class="seg-title">ACUERDOS</div>
          <div id="acu-out" class="muted">‚Äî Sin contenidos a√∫n ‚Äî</div>
        </div>

      </section>

      <!-- ===== LATERAL DERECHO: Fichas activas ===== -->
      <aside class="fichas-panel">
        <h3 style="margin-bottom:8px;">Fichas</h3>
        <div id="lista-fichas" class="fichas-lista muted">‚Äî sin fichas ‚Äî</div>
      </aside>
    </div>
  </main>
</div>

<!-- ====== SCRIPTS ====== -->
<script type="module">
  /* ============== Montar header global + store compartido ============== */
  import { mountHeader } from "../js/header.js";
  import { FichasStore } from "../js/fichasStore.js";

  mountHeader();
  window.FichasStore = FichasStore;

  /* ============== Utilidades b√°sicas ============== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = ts => new Date(ts).toLocaleString('es-CL');

// ===== Estado inicial: sin ficha seleccionada =====
function noFichaState(){
  // t√≠tulo vistoso
  const hdr = document.querySelector('#header-paciente');
  if(hdr){
    hdr.style.display = 'block';
    hdr.style.fontSize = '20px';
    hdr.style.fontWeight = '700';
    hdr.textContent = 'Sin ficha seleccionada';
  }
  // mostrar solo el tab "CREAR FICHA"
  const keep = new Set(['ficha']);
  ALL_TABS.forEach(t=>{
    const btn = document.querySelector(`.tab-btn[data-tab="${t}"]`);
    const pnl = document.querySelector(`#panel-${t}`);
    const vis = keep.has(t);
    if(btn) btn.style.display = vis ? 'inline-flex' : 'none';
    if(pnl) pnl.style.display = vis ? 'block' : 'none';
  });
  showTab('ficha');
  renderAntecedentesFromStore();
}

/* ============== Tabs: helpers ============== */
const ALL_TABS = ['ficha','ante','anam','meds','ea','prm','edu','herr','indi','acu'];

function showTab(key) {
  ALL_TABS.forEach(t => {
    const p = document.querySelector(`#panel-${t}`);
    const btn = document.querySelector(`.tab-btn[data-tab="${t}"]`);
    if (p) p.style.display = (t === key) ? 'block' : 'none';
    if (btn) btn.classList.toggle('active', t === key);
  });
}

  // Estado inicial: solo FICHA visible
  showTab('ficha');

  /* ============== L√≥gica de flujo por tipo de atenci√≥n ============== */
  const FLOW = {
    'SIN ENTREVISTA: CONCILIACI√ìN': ['ficha','ante','meds','prm','herr','indi'],
    'SIN ENTREVISTA: RAM':          ['ficha','ante','anam','ea','meds','prm','indi'],
    'CON ENTREVISTA: REGULAR':      ['ficha','ante','anam','meds','ea','prm','edu','indi'],
    'CON ENTREVISTA: AMPLIADA':     ['ficha','ante','anam','meds','ea','prm','edu','herr','indi','acu']
  };
function aplicarTabsPorTipo(tipo) {
  // Determina los tabs que deben mantenerse visibles
  const keep = new Set(FLOW[tipo] || ['ficha', 'ante']);

  ALL_TABS.forEach(t => {
    // Selecciona los botones y paneles sin usar $()
    const btn = document.querySelector(`.tab-btn[data-tab="${t}"]`);
    const pnl = document.querySelector(`#panel-${t}`);
    const vis = keep.has(t);

    // Mostrar u ocultar los botones de tab
    if (btn) btn.style.display = vis ? 'inline-flex' : 'none';

    // Mostrar u ocultar el contenido del panel
    if (pnl) {
      // Muestra solo el panel activo; oculta el resto
      pnl.style.display = vis && t === 'ficha' ? 'block' : (vis ? 'none' : 'none');
    }
  });
}


  /* ============== Chips din√°micos por edad/sexo ============== */
  const $mayor65 = $('#mayor65');
  const $sexo = $('#sexo');
  const chip65 = $('#chip-65');
  const chipEmb = $('#chip-emb');
  function updateChips(){
    const es65 = !!($mayor65 && $mayor65.checked);
    const esF = ($sexo && $sexo.value === 'F');
    if (chip65) chip65.style.display = es65 ? 'inline-flex' : 'none';
    if (chipEmb) chipEmb.style.display = (esF && !es65) ? 'inline-flex' : 'none';
  }
  if($mayor65) $mayor65.addEventListener('change', updateChips);
  if($sexo) $sexo.addEventListener('change', updateChips);
  updateChips();

/* ============== Render lateral de fichas ============== */
const listaFichas = document.querySelector('#lista-fichas');

function renderLista() {
  // Obtener lista desde almacenamiento o vac√≠a
  const L = FichasStore.list().slice().sort((a, b) => (b.lastActive || 0) - (a.lastActive || 0));

  if (!listaFichas) return;

  // Si no hay fichas
  if (L.length === 0) {
    listaFichas.innerHTML = '‚Äî sin fichas ‚Äî';
    return;
  }

  // Limpia el contenedor
  listaFichas.innerHTML = '';

  // Genera cada ficha
  L.forEach(f => {
    const icon = f.sexo === 'F' ? '‚ôÄ' : f.sexo === 'M' ? '‚ôÇ' : '‚Ä¢';
    const chip = f.age65 ? `<span class="chip" style="margin-left:6px;">‚â•65</span>` : '';
    const fecha = f.lastActive ? new Date(f.lastActive).toLocaleString('es-CL') : '';
    
    // Crea la tarjeta
    const card = document.createElement('div');
    card.className = 'ficha-card';
        if(f.id === window.activeId) card.classList.add('active');
    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div><b>${f.id}</b> ${icon} ${chip}</div>
        <div style="display:flex;gap:6px;">
          <button class="btn mini" data-open="${f.id}">Abrir</button>
          <button class="btn mini warn" data-del="${f.id}" title="Eliminar ficha">üóëÔ∏è</button>
        </div>
      </div>
      <div class="muted" style="font-size:12px;">${fecha}</div>
    `;
        card.querySelector('[data-open]')?.addEventListener('click', () => openFicha(f.id));
    card.querySelector('[data-del]')?.addEventListener('click', () => eliminarFicha(f.id));
    listaFichas.appendChild(card);
  });
}

/* ============== Eliminar ficha ============== */
function eliminarFicha(id) {
  if (!confirm(`¬øEliminar ficha ${id}?`)) return;
  FichasStore.remove(id);
  if(window.activeId === id){
    window.activeId = null;
    noFichaState();
  }
  renderLista();
}


/* ============== T√≠tulo din√°mico con datos del paciente ============== */
  // Header paciente
function updateHeaderPaciente(f){
  const hdrPac = document.querySelector('#header-paciente');
  if(!f || !hdrPac){ if(hdrPac){hdrPac.style.display='none';hdrPac.textContent='';} return; }
  const sexoStr = f.sexo === 'F' ? 'Femenino' : (f.sexo === 'M' ? 'Masculino' : '-');
  const edadStr = f.age65 ? '‚â•65' : '';
  hdrPac.textContent = `${f.id} ¬∑ ${sexoStr}${edadStr? ' ¬∑ ' + edadStr : ''}`;
  hdrPac.style.display = 'block';

  }

  /* ============== Crear ficha (validaci√≥n completa) ============== */
  const $ini = $('#ini');
  const $btnCrear = $('#btn-crear');
  const tiposBtns = [
    { id: 'tipo-sinconc', label: 'SIN ENTREVISTA: CONCILIACI√ìN' },
    { id: 'tipo-sinram',  label: 'SIN ENTREVISTA: RAM' },
    { id: 'tipo-conreg',  label: 'CON ENTREVISTA: REGULAR' },
    { id: 'tipo-conmais', label: 'CON ENTREVISTA: AMPLIADA' }
  ];
  let tipoSeleccionado = null;
  function marcarTipo(btnId){
    const obj = tiposBtns.find(t => t.id===btnId);
    tipoSeleccionado = obj ? obj.label : null;
    tiposBtns.forEach(t => {
      const b = $('#'+t.id);
      if(!b) return;
      if(t.id===btnId){ b.classList.add('active'); b.style.background='#1a3a69'; }
      else{ b.classList.remove('active'); b.style.background='#101c33'; }
    });
  }
  tiposBtns.forEach(t => $('#'+t.id).addEventListener('click', ()=>marcarTipo(t.id)));

  function generarIdDesdeIniciales(initials){
    return (initials||'').trim().toUpperCase().replace(/[^A-Z]/g,'').slice(0,3);
  }

  function crearFicha(){
    const iniciales = ($ini.value||'').trim().toUpperCase();
    const es65 = !!($mayor65 && $mayor65.checked);
    const sexoVal = $sexo.value;

    if(!iniciales){ alert('Debes ingresar las iniciales.'); return; }
    if(!sexoVal){ alert('Debes seleccionar el sexo.'); return; }
    if(!tipoSeleccionado){ alert('Selecciona un tipo de atenci√≥n.'); return; }

    const id = generarIdDesdeIniciales(iniciales);
       if(id.length !== 3){ alert('Iniciales inv√°lidas. Usa 3 letras A‚ÄìZ.'); return; }

    try{
      FichasStore.create(id, { age65: es65, sexo: sexoVal, tipoAtencion: tipoSeleccionado });
    }catch(e){
      if(!/Ya existe/.test(e.message)){ alert(e.message); return; }
    }

        FichasStore.update(id, f => {
      f.age65 = es65;
      f.sexo = sexoVal;
      f.tipoAtencion = tipoSeleccionado;
    });

    renderLista();
    openFichaSafe(id);
        if($ini) $ini.value = '';
  }
  $btnCrear.addEventListener('click', crearFicha);

  /* ============== Abrir ficha (flujo oficial) ============== */
  window.activeId = window.activeId || null;
  function openFicha(id){
    const f = FichasStore.get(id);
    if(!f) return;
    window.activeId = id;
    FichasStore.update(id, () => {});
    const nf = FichasStore.get(id);
    updateHeaderPaciente(nf);
    aplicarTabsPorTipo(nf?.tipoAtencion);
    if($ini) $ini.value = nf?.id || '';
    if($mayor65) $mayor65.checked = !!nf?.age65;
    if($sexo) $sexo.value = nf?.sexo || '';
    const tipoEntry = tiposBtns.find(t => t.label === nf?.tipoAtencion);
    if(tipoEntry){
      marcarTipo(tipoEntry.id);
    }else{
      tipoSeleccionado = null;
      tiposBtns.forEach(t => {
        const b = document.getElementById(t.id);
        if(b){ b.classList.remove('active'); b.style.background = '#101c33'; }
      });
    }
    renderAntecedentesFromStore();
    showTab('ante'); // SIEMPRE iniciar en ANTECEDENTES
    renderLista();
    updateChips(); // refrescar chips seg√∫n edad/sexo
  }
  const _openFichaLegacy = window.openFicha;
  window.openFicha = function(id){
    if(typeof _openFichaLegacy === 'function'){ try{ _openFichaLegacy(id); }catch{} }
    openFicha(id);
  };
  window.openFichaSafe = id => window.openFicha(id);

/* ============= Conciliaci√≥n / Errores m√≠nimos ============= */

// ----- Bot√≥n de conciliaci√≥n -----
document.querySelector('#btn-conciliar')?.addEventListener('click', () => {
  if (!window.activeId) {
    alert('Abre una ficha primero.');
    return;
  }

  FichasStore.update(window.activeId, f => {
    f.conciliacion = { estado: 'conciliado', fecha: Date.now() };
  });

  alert('Conciliaci√≥n registrada correctamente.');
});


// ----- Bot√≥n agregar error -----
document.querySelector('#err-add')?.addEventListener('click', () => {
  if (!window.activeId) {
    alert('Abre una ficha primero.');
    return;
  }

  const etapaInput = document.querySelector('#err-etapa');
  const descInput = document.querySelector('#err-desc');
  const listaErrores = document.querySelector('#errores-list');

  if (!etapaInput || !descInput || !listaErrores) return;

  const etapa = etapaInput.value.trim();
  const desc = descInput.value.trim();

  if (!etapa || !desc) {
    alert('Completa etapa y descripci√≥n.');
    return;
  }

  // Actualiza en FichasStore
   FichasStore.update(window.activeId, f => {
    f.meds = f.meds || {};
    f.meds.errores = f.meds.errores || [];
    f.meds.errores.push({ etapa, desc, ts: Date.now() });
  });

  // Refresca visualmente la lista
  const li = document.createElement('li');
  li.textContent = `${etapa}: ${desc}`;
  listaErrores.appendChild(li);

  // Limpia el campo
  descInput.value = '';
});

/* ============= Sugerencias Antecedentes y entrada ============= */
const ANT_SUG = [
  "HTA", "DM2 IR", "DM2 NIR", "DLP", "HIPOT4", "ERC",
  "POLIARTROSIS", "OB", "TR SUE√ëO", "TR DEPRESIVO"
];

// Renderiza las sugerencias si el select existe
const antSuggest = document.querySelector('#ant-suggest');
if (antSuggest) {
  antSuggest.innerHTML = ANT_SUG.map(
    x => `<option value="${x}">${x}</option>`
  ).join('');
}

// Captura entrada manual de antecedentes
const antInput = document.querySelector('#ant-input');
const antList = document.querySelector('#ant-list');

function renderAntecedentesFromStore(){
  if(!antList) return;
  antList.innerHTML = '';
  if(!window.activeId) return;
  const f = FichasStore.get(window.activeId);
  (f?.anamnesis?.antecedentes || []).forEach(val => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.textContent = val;
    const btn = document.createElement('span');
    btn.className = 'trash';
    btn.title = 'Quitar';
    btn.textContent = '‚úï';
    btn.dataset.remove = val;
    btn.addEventListener('click', () => {
      FichasStore.update(window.activeId, ff => {
        ff.anamnesis = ff.anamnesis || { antecedentes: [] };
        ff.anamnesis.antecedentes = (ff.anamnesis.antecedentes || []).filter(x => x !== val);
      });
      renderAntecedentesFromStore();
    });
    chip.appendChild(btn);
    antList.appendChild(chip);
  });
}

if (antInput && antList) {
  antInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const v = e.target.value.trim();
      if (!v) return;

      e.target.value = '';

      // Guarda en ficha activa si existe
      if (window.activeId) {
        FichasStore.update(window.activeId, f => {
          f.anamnesis = f.anamnesis || { antecedentes: [] };
          const arr = f.anamnesis.antecedentes || [];
          if(!arr.includes(v)) arr.push(v);
          f.anamnesis.antecedentes = arr;
        });
                renderAntecedentesFromStore();
      }
    }
  });
}

/* ============== Inicializar pantalla ============== */
// restaurar lista persistente
renderLista();

// Abrir ficha desde el hash si corresponde
const hashId = (location.hash || '').replace('#', '').toUpperCase();
if (hashId && FichasStore.get(hashId)) {
  openFicha(hashId);
}

window.addEventListener('hashchange', () => {
  const h = (location.hash || '').replace('#', '').toUpperCase();
  if (h && FichasStore.get(h)) {
    openFicha(h);
  }
});

// Estado inicial sin ficha seleccionada
if (!window.activeId) { noFichaState(); }
</script>
</body>
</html>
