<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO — Calculadoras</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body class="page">
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Calculadoras</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">🏷️ Inicio</a>
      <a class="nav-item" href="atencion.html">🧑‍⚕️ Atención</a>
      <a class="nav-item active" href="calculadoras.html">🧮 Calculadoras</a>
      <a class="nav-item" href="tests.html">🧪 Tests</a>
      <a class="nav-item" href="material.html">📚 Material de consulta</a>
      <a class="nav-item" href="proa.html">🧫 PROA</a>
      <a class="nav-item" href="config.html">⚙️ Configuración</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>
    <main class="container">
      <div class="row" style="gap:8px">
        <label>Modo:
          <select id="modo">
            <option value="libre">Libre</option>
            <option value="ficha">Asociado a ficha…</option>
          </select>
        </label>
        <select id="sel-ficha" style="display:none"></select>
      </div>

      <!-- ECICEP DEMO -->
      <div class="card" style="margin-top:16px">
        <h3>ECICEP (demo)</h3>
        <div class="muted">Marca comorbilidades (demo). G0–G3 según recuento.</div>
        <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:6px">
          <label class="pick"><input type="checkbox" class="ec" value="HTA"> HTA</label>
          <label class="pick"><input type="checkbox" class="ec" value="DM2"> DM2</label>
          <label class="pick"><input type="checkbox" class="ec" value="DLP"> DLP</label>
          <label class="pick"><input type="checkbox" class="ec" value="ERC"> ERC</label>
          <label class="pick"><input type="checkbox" class="ec" value="ICC"> ICC</label>
          <label class="pick"><input type="checkbox" class="ec" value="EPOC"> EPOC</label>
          <label class="pick"><input type="checkbox" class="ec" value="DEP"> Depresión</label>
        </div>
        <div class="row" style="gap:8px;margin-top:8px">
          <button id="ec-calc" class="btn">Calcular</button>
          <span id="ec-out" class="pill"></span>
          <button id="ec-save" class="btn" disabled>Guardar en ficha</button>
        </div>
      </div>

      <!-- Paracetamol pediátrico -->
      <div class="card" style="margin-top:16px">
        <h3>Paracetamol pediátrico (mg/kg/día)</h3>
        <div class="row" style="gap:8px">
          <label>Peso (kg): <input id="peso" type="number" min="1" step="0.1" style="width:90px"></label>
          <label>Dosis (mg/kg/día): <input id="dosis" type="number" value="60" step="1" style="width:110px"></label>
          <button id="btn-calc" class="btn">Calcular</button>
        </div>
      </div>

      <div id="out" class="list" style="margin-top:16px"></div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { FichasStore } from "../js/fichasStore.js";
  mountHeader();

  const $modo=document.getElementById('modo'), $sel=document.getElementById('sel-ficha');
  const $peso=document.getElementById('peso'), $dosis=document.getElementById('dosis'), $btn=document.getElementById('btn-calc'), $out=document.getElementById('out');

  function refreshFichas(){ $sel.innerHTML=FichasStore.list().map(f=>`<option>${f.id}</option>`).join(""); }
  $modo.onchange=()=>{ $sel.style.display=$modo.value==='ficha'?'inline-block':'none'; if($modo.value==='ficha') refreshFichas(); };

  // Paracetamol
  $btn.onclick=()=>{
    const peso=parseFloat($peso.value), dosisDia=parseFloat($dosis.value);
    if(!peso||!dosisDia){ alert("Ingresa valores válidos."); return; }
    const mgDia=peso*dosisDia, mg8=(mgDia/3).toFixed(1);
    const res=`Peso ${peso} kg → ${mgDia.toFixed(1)} mg/día (~${mg8} mg cada 8 h)`;
    $out.innerHTML=`<div class="card">🧮 ${res}</div>` + $out.innerHTML;
    if($modo.value==='ficha' && $sel.value){
      FichasStore.update($sel.value, f=> f.calculos.push({tipo:"Paracetamol pediátrico",datosEntrada:{peso,dosisDia},resultado:res,fecha:Date.now(),asociado:true}));
    }
  };

  // ECICEP demo
  const ecBoxes = ()=> Array.from(document.querySelectorAll('.ec')).filter(x=>x.checked).length;
  document.getElementById('ec-calc').onclick=()=>{
    const c = ecBoxes();
    const g = c<=1?'G0':(c<=3?'G1':(c<=5?'G2':'G3'));
    document.getElementById('ec-out').textContent = `ECICEP (demo): ${g} (${c} patologías)`;
    document.getElementById('ec-save').disabled = false;
  };
  document.getElementById('ec-save').onclick=()=>{
    if($modo.value!=='ficha' || !$sel.value) return;
    const txt = document.getElementById('ec-out').textContent||''; if(!txt) return;
    FichasStore.update($sel.value, f=> f.calculos.push({ tipo:'ECICEP demo', resultado: txt, fecha: Date.now(), asociado:true }));
    $out.innerHTML = `<div class="card">💾 Guardado en ficha ${$sel.value}: ${txt}</div>` + $out.innerHTML;
    document.getElementById('ec-save').disabled = true;
  };
</script>
</body>
</html>
