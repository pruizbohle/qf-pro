<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QF PRO â€” Material de consulta</title>
  <link rel="stylesheet" href="../css/styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><strong>QF PRO</strong><br><span class="muted">Material</span></div>
    <nav style="margin-top:12px">
      <a class="nav-item" href="../index.html">ğŸ·ï¸ Inicio</a>
      <a class="nav-item" href="atencion.html">ğŸ§‘â€âš•ï¸ AtenciÃ³n farmacÃ©utica</a>
      <a class="nav-item" href="generador.html">ğŸ“ Generador de texto</a>
      <a class="nav-item" href="vademecum.html">ğŸ’Š VademÃ©cum</a>
      <a class="nav-item active" href="material.html">ğŸ“š Material de consulta</a>
      <a class="nav-item" href="herramientas.html">ğŸ§° Herramientas</a>
      <a class="nav-item" href="proa.html">ğŸ§ª PROA</a>
      <a class="nav-item" href="plantas.html">ğŸŒ¿ Plantas medicinales</a>
      <a class="nav-item" href="protocolos.html">ğŸ“‘ Orientaciones tÃ©cnicas</a>
      <a class="nav-item" href="config.html">âš™ï¸ ConfiguraciÃ³n</a>
    </nav>
  </aside>

  <div class="main">
    <div id="header"></div>
    <main class="container">
      <h2>Colecciones</h2>
      <div class="fichas-wrap" style="margin-top:10px">
        <a class="card" href="vademecum.html"><b>VademÃ©cum</b><div class="muted">BÃºsqueda de fÃ¡rmacos y presentaciones</div></a>
        <a class="card" href="material.html#beers"><b>Beers/STOPP/START</b><div class="muted">Criterios geriÃ¡tricos</div></a>
        <a class="card" href="material.html#renal"><b>Ajuste renal</b><div class="muted">Medicamentos con ajuste en ERC</div></a>
        <a class="card" href="material.html#embarazo"><b>Embarazo</b><div class="muted">Precauciones y contraindicaciones</div></a>
        <a class="card" href="material.html#interacciones"><b>Interacciones</b><div class="muted">Interacciones clÃ­nicamente relevantes</div></a>
        <a class="card" href="material.html#arsenal"><b>Arsenales</b><div class="muted">Listas APS / Secundario</div></a>
      </div>

      <h2 style="margin-top:18px">BÃºsqueda rÃ¡pida</h2>
      <div class="card">
        <input id="q" placeholder="Ej: losartÃ¡n, embarazo, STOPP, simvastatina+claritromicina">
        <div class="row" style="margin-top:8px"><button id="go" class="btn">Buscar</button></div>
        <div id="out" class="list" style="margin-top:10px"></div>
      </div>
      
      <h2 id="tags" style="margin-top:24px">Etiquetas terapÃ©uticas</h2>
      <div id="tags-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px"></div>

      <h2 id="flags" style="margin-top:24px">Alertas clÃ­nicas</h2>
      <div id="flags-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px"></div>
    </main>
  </div>
</div>

<script type="module">
  import { mountHeader } from "../js/header.js";
  import { loadAll } from "../js/medStore.js";

  mountHeader();
  const $q=document.getElementById('q'), $go=document.getElementById('go'), $out=document.getElementById('out');
  const $tags=document.getElementById('tags-grid');
  const $flags=document.getElementById('flags-grid');
  const params=new URLSearchParams(location.search); if(params.get('q')) $q.value=params.get('q');

  $go.onclick=()=>{
    const v=($q.value||'').toLowerCase();
    $out.innerHTML='';
    if(!v) return;
    if(v.includes('interacc')) $out.innerHTML='<div class="card">ğŸ”— Te conviene ir a <a class="pill" href="vademecum.html#interacciones">Interacciones del vademÃ©cum</a></div>';
    else if(v.includes('beers')||v.includes('stopp')||v.includes('start')) $out.innerHTML='<div class="card">ğŸ“ Ver criterios en colecciones (demo)</div>';
    else $out.innerHTML='<div class="card">ğŸ” Consulta general â€” integraremos buscador avanzado</div>';
  };
  
  loadAll().then(db=>{
    const meds=Object.values(db.meds||{});
    renderTags(meds);
    renderFlags(meds);
  }).catch(err=>{
    console.error('âŒ No se pudo cargar medicamentos para material:', err);
  });

  function renderTags(meds){
    if(!$tags) return;
    const map=new Map();
    meds.forEach(m=>{
      (m.etiquetas||[]).forEach(tag=>{
        const key=tag.trim();
        if(!key) return;
        if(!map.has(key)) map.set(key,[]);
        map.get(key).push(m);
      });
    });
    const cards=Array.from(map.entries())
      .sort((a,b)=>b[1].length-a[1].length||a[0].localeCompare(b[0]))
      .map(([tag,items])=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div><b>${tag}</b></div>
            <span class="pill">${items.length}</span>
          </div>
          <ul class="list" style="margin-top:8px">
            ${items.map(m=>`<li><b>${m.nombre}</b><div class="muted" style="font-size:12px">${m.presentacion||''}</div></li>`).join('')}
          </ul>
        </div>
      `)
      .join('');
    $tags.innerHTML=cards||'<div class="card muted">Sin etiquetas disponibles</div>';
  }

  function renderFlags(meds){
    if(!$flags) return;
    const defs=[
      {
        title:'Requiere ajuste renal',
        items:meds.filter(m=>m.flags?.ajuste_renal?.requerido),
        detail:m=>m.flags?.ajuste_renal?.detalle
      },
      {
        title:'Contraindicado en ERC',
        items:meds.filter(m=>m.flags?.contraindicado_renal?.activo),
        detail:m=>m.flags?.contraindicado_renal?.detalle
      },
      {
        title:'Potencialmente inapropiado (PPI)',
        items:meds.filter(m=>m.flags?.ppi),
        detail:()=> 'Revisar uso en adultos mayores/poblaciones sensibles.'
      },
      {
        title:'START recomendado',
        items:meds.filter(m=>m.flags?.start),
        detail:()=> 'Considerar iniciar segÃºn criterios START.'
      }
    ];

    const riesgoMap=new Map();
    meds.forEach(m=>{
      const riesgo=(m.flags?.embarazo?.riesgo||'N/A').toUpperCase();
      if(riesgo==='N/A') return;
      if(!riesgoMap.has(riesgo)) riesgoMap.set(riesgo,[]);
      riesgoMap.get(riesgo).push(m);
    });

    const flagCards=defs.map(def=>`
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><b>${def.title}</b></div>
          <span class="pill">${def.items.length}</span>
        </div>
        ${def.items.length ? `
          <ul class="list" style="margin-top:8px">
            ${def.items.map(m=>`<li><b>${m.nombre}</b><div class="muted" style="font-size:12px">${def.detail(m)||''}</div></li>`).join('')}
          </ul>` : `<div class="muted" style="margin-top:8px">Sin registros</div>`}
      </div>
    `).join('');

    const embarazoCard = riesgoMap.size ? `
      <div class="card">
        <div><b>Embarazo</b></div>
        <div class="muted" style="font-size:12px;margin-top:4px">ClasificaciÃ³n por categorÃ­a de riesgo</div>
        <ul class="list" style="margin-top:8px">
          ${Array.from(riesgoMap.entries())
            .sort((a,b)=>a[0].localeCompare(b[0]))
            .map(([riesgo,items])=>`<li><div class="row" style="justify-content:space-between"><span><b>Riesgo ${riesgo}</b></span><span class="pill">${items.length}</span></div><div class="muted" style="margin-top:4px">${items.map(m=>m.nombre).join(', ')}</div></li>`)
            .join('')}
        </ul>
      </div>
    ` : '';

    $flags.innerHTML = (flagCards + embarazoCard) || '<div class="card muted">Sin alertas disponibles</div>';
  }
</script>
</body>
</html>
